<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบลงทะเบียนห้องเรียน (Offline)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .resizer {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: col-resize;
            z-index: 20;
            transform: translateX(-50%);
            pointer-events: auto;
            transition: background-color 0.2s ease;
        }
        .resizer:hover {
            background-color: rgba(79, 70, 229, 0.2);
        }

        /* --- Updated Styles for A4 preview frame with Scaling --- */
        .a4-preview-page {
            background-color: white;
            /* A more prominent shadow to simulate a real page, removed border for cleaner look */
            box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .a4-preview-page.a4-landscape {
            width: 297mm;
            height: 210mm;
        }
        .a4-preview-page.a4-portrait {
            width: 210mm;
            height: 297mm;
        }
        #print-preview-scaler {
            transform-origin: top center;
            transition: transform 0.2s ease;
        }


        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-container, #print-container * {
                visibility: visible;
            }
            #print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
            }
            /* @page rule is now dynamically added by JS */
            .print-page {
                page-break-after: always;
                box-shadow: none !important;
                border: none !important;
                height: 100%;
                width: 100%;
                display: flex;
                flex-direction: column;
            }
             .print-page .print-grid-wrapper {
                height: 100%;
                flex-grow: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Toast Notification -->
    <div id="toast-notification" class="hidden fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-[100]">
        <span id="toast-message"></span>
    </div>

    <div class="w-full p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">ระบบลงทะเบียนห้องเรียน (Offline)</h1>
        </header>
        
        <div id="main-flow" class="relative">
             <!-- New Manage Rooms Button Container -->
            <div class="flex justify-end mb-4">
                <button id="manage-classrooms-btn" title="จัดการห้อง" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.424.35.534.954.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37.49l1.217.456c.355.133.75.072 1.076.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>จัดการห้อง</span>
                </button>
            </div>
            
            <!-- Register Room Card -->
            <div id="register-room-card" class="bg-white p-6 rounded-lg shadow-lg min-h-[300px] flex flex-col items-center justify-center">
                 <!-- Loading Spinner -->
                <div id="loader" class="loader hidden"></div>
                <div id="building-content" class="w-full hidden flex-grow flex flex-col">
                     <!-- Building Selector -->
                    <div class="mb-2 text-center">
                        <h2 class="text-2xl font-bold text-gray-950 mb-4">ลงทะเบียนตึก</h2>
                        <div id="building-buttons" class="flex flex-wrap gap-2 justify-center items-center">
                            <!-- Building buttons will be generated here -->
                        </div>
                    </div>
                    
                    <div class="w-full border-t border-gray-300 my-4"></div>
    
    
                    <!-- NEW HEADER & ACTION BAR -->
                    <div class="mb-4 text-center">
                        <h2 class="text-2xl font-bold text-gray-950 mb-3">ลงทะเบียนห้องเรียน</h2>
            
                    </div>
                    <div class="relative mt-2 mb-2 px-1 text-center min-h-[48px] flex justify-center items-center">
                         <div id="action-bar-controls" class="absolute left-1 top-1/2 -translate-y-1/2 transform scale-85 origin-left">
                            <!-- Normal Mode Controls -->
                            <div id="normal-mode-controls" class="flex items-center gap-2">
                                <div class="flex items-center gap-1 p-1 bg-gray-100 rounded-lg border">
                                    <button id="undo-btn" title="Undo" class="p-1.5 bg-white hover:bg-gray-200 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg class="w-4 h-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                           <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
                                        </svg>
                                    </button>
                                    <button id="redo-btn" title="Redo" class="p-1.5 bg-white hover:bg-gray-200 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg class="w-4 h-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                           <path stroke-linecap="round" stroke-linejoin="round" d="M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 000 12h3" />
                                        </svg>
                                    </button>
                                </div>
                                <div class="border-l h-6 border-gray-300 mx-1"></div>
                                <button id="toggle-merge-mode-btn" class="bg-transparent hover:bg-gray-100 text-gray-950 border border-black font-semibold py-2 px-3 rounded-lg text-sm transition-colors flex items-center gap-2">
                                    <span>[--&gt; รวมห้อง &lt;--]</span>
                                </button>
                                <button id="reset-building-btn" class="bg-black hover:bg-gray-800 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-colors">
                                    ว่างทั้งหมด
                                </button>
                            </div>
                            <!-- Merge Mode Controls -->
                            <div id="merge-actions" class="hidden">
                                <div class="bg-indigo-100 border border-indigo-200 rounded-lg p-2 flex items-center gap-3">
                                    <p class="text-sm text-indigo-800 font-medium">เลือกห้องที่ต้องการรวม</p>
                                    <div class="flex gap-2">
                                        <button id="confirm-merge-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1.5 px-4 rounded-lg text-sm">รวม</button>
                                        <button id="cancel-merge-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-1.5 px-4 rounded-lg text-sm">ยกเลิก</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <h2 id="building-title" class="text-2xl font-bold inline-block"></h2>
                    </div>
    
                    <div class="w-full border-t border-gray-200 my-2"></div>
    
                    <div class="flex justify-start mb-2 px-1">
                        <p class="text-xs text-gray-500 flex items-center gap-2">
                              การปรับขนาดห้อง : ให้ขยับเส้นแบ่งห้อง 
                              <span class="flex items-center text-gray-700 font-semibold">
                                (ซ้าย&nbsp;
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-1">
                                   <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                   <path d="M8 12h-6" /><path d="M5 15l-3 -3l3 -3" /><path d="M22 12h-6" /><path d="M19 15l3 -3l-3 -3" /><path d="M12 4v16" />
                                </svg>
                                &nbsp;ขวา)
                              </span>
                        </p>
                    </div>
                    
                    <div class="relative px-4 sm:px-8 py-10 flex-grow">
                        <!-- Row Controls (Top Center, SCALED & VERTICAL) -->
                        <div id="row-controls" class="absolute top-0 left-1/2 -translate-y-1/2 flex flex-col items-center bg-white rounded-full px-1 py-2 shadow-md border z-30 transform scale-75">
                            <button id="add-row-btn" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-800 transition-colors" title="เพิ่มชั้น">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                            </button>
                            <div class="border-t border-gray-300 w-4 my-1"></div>
                            <button id="delete-row-btn" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-800 transition-colors" title="ลบชั้น">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>
                            </button>
                        </div>
    
                        <!-- Column Controls (Right Center, SCALED) -->
                         <div id="col-controls" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-1/2 flex items-center bg-white rounded-full px-2 py-1 shadow-md border z-30 transform scale-75">
                            <button id="delete-col-btn" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-800 transition-colors" title="ลบห้อง">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>
                            </button>
                            <div class="border-l border-gray-300 h-4 mx-1"></div>
                            <button id="add-col-btn" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-800 transition-colors" title="เพิ่มห้อง">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                            </button>
                        </div>
    
                        <!-- Main Room Grid -->
                        <div id="room-grid-container">
                            <!-- Rows (label + grid) will be dynamically generated here -->
                        </div>
                    </div>
    
                    <!-- Room Summary Section (Moved Here) -->
                    <div class="w-full border-t border-gray-200 mt-4 pt-4">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700 px-1 text-center">สรุปจำนวนห้อง</h3>
                        <div class="flex justify-center">
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 text-sm px-1 transform scale-90">
                                <div class="p-3 bg-transparent border border-black text-black hover:bg-black hover:text-white font-bold rounded-lg shadow flex justify-between items-center transition-colors duration-200"><span>ห้องเรียน:</span><span id="classroom-count">0</span></div>
                                <div class="p-3 bg-transparent border border-yellow-500 text-yellow-600 hover:bg-yellow-500 hover:text-white font-bold rounded-lg shadow flex justify-between items-center transition-colors duration-200"><span>ห้องปฏิบัติการ:</span><span id="lab-count">0</span></div>
                                <div class="p-3 bg-transparent border border-slate-500 text-slate-600 hover:bg-slate-500 hover:text-white font-bold rounded-lg shadow flex justify-between items-center transition-colors duration-200"><span>ห้องสำนักงาน:</span><span id="office-count">0</span></div>
                                <div class="p-3 bg-transparent border border-red-600 text-red-600 hover:bg-red-600 hover:text-white font-bold rounded-lg shadow flex justify-between items-center transition-colors duration-200"><span>ปิดปรับปรุง:</span><span id="renovation-count">0</span></div>
                                <div class="p-3 bg-transparent border border-dashed border-gray-300 text-gray-500 hover:bg-gray-400 hover:text-white font-light rounded-lg shadow flex justify-between items-center transition-colors duration-200"><span>ห้องว่าง:</span><span id="vacant-count">0</span></div>
                            </div>
                        </div>
                    </div>
    
                </div>
            </div>
        </div>

        <!-- Student Room Summary Card -->
        <div id="student-room-summary-card" class="mt-6 bg-white p-4 rounded-lg shadow-lg">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">สรุปห้องนักเรียน</h3>
            <div id="student-room-summary-selector" class="flex flex-wrap gap-1.5 mb-4">
                <!-- Category selector buttons will be generated here -->
            </div>
            <div id="student-room-summary-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 2xl:grid-cols-10 gap-4 text-sm">
                 <!-- Student room summary will be generated here -->
            </div>
        </div>

        <!-- Building Summary Card -->
        <div id="building-summary-card" class="mt-6 bg-white p-4 rounded-lg shadow-lg">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">สรุปอาคาร</h3>
            <div id="building-summary-selector" class="flex flex-wrap gap-1.5 mb-4">
                <!-- Building selector buttons will be generated here -->
            </div>
            <div id="building-summary-table-container">
                <!-- Summary tables will be generated here -->
            </div>
        </div>
    </div>

    <!-- Modal for Editing Room Data -->
    <div id="edit-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 max-w-lg relative">
            <h3 class="text-xl font-bold mb-4" id="modal-title">แก้ไขข้อมูลห้อง</h3>
            <form id="edit-form">
                 <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทห้อง</label>
                    <div id="room-type-selector" class="flex flex-wrap items-center gap-2">
                        <!-- Room type buttons are generated dynamically -->
                    </div>
                </div>

                <fieldset id="edit-fieldset">
                    <div class="mb-4">
                        <label for="room-id" class="block text-sm font-medium text-gray-700">รหัสห้อง</label>
                        <input type="text" id="room-id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="room-name-container" class="block text-sm font-medium text-gray-700">ชื่อห้อง</label>
                        <div id="room-name-container" class="mt-1">
                            <select id="room-name-select" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                <!-- Options will be dynamically populated -->
                            </select>
                            <input type="text" id="room-name-input" class="hidden w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="room-details" class="block text-sm font-medium text-gray-700">รายละเอียดห้อง</label>
                        <textarea id="room-details" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                </fieldset>
                
                <div class="flex justify-between items-center mt-2">
                     <button type="button" id="unmerge-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm hidden">แยกห้อง</button>
                     <button type="button" id="delete-data-button" class="text-red-600 hover:text-red-800 font-semibold text-sm underline ml-auto">ล้างข้อมูลห้องนี้</button>
                </div>
                
                <div class="border-t my-4"></div>

                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" id="cancel-button" class="bg-transparent border border-gray-400 text-gray-600 font-normal hover:bg-gray-100 py-2 px-4 rounded-lg transition-colors">
                        ยกเลิก
                    </button>
                    <button type="submit" id="save-button" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Adding/Editing Building -->
    <div id="building-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/4 max-w-sm relative">
            <h3 class="text-xl font-bold mb-4" id="building-modal-title">เพิ่มตึกใหม่</h3>
            <form id="building-form">
                <div class="mb-4">
                    <label for="building-name-input" class="block text-sm font-medium text-gray-700">ชื่อตึก</label>
                    <input type="text" id="building-name-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" id="building-cancel-btn" class="bg-transparent border border-gray-400 text-gray-600 font-normal hover:bg-gray-100 py-2 px-4 rounded-lg transition-colors">
                        ยกเลิก
                    </button>
                    <button type="submit" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Classroom Names Modal -->
    <div id="classroom-names-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-2/3 max-w-4xl xl:max-w-6xl relative flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4 flex-shrink-0">จัดการห้องเรียน</h3>
            
            <div class="flex-shrink-0 mb-4 flex items-center gap-2 border-b pb-4">
                 <div id="classroom-category-buttons" class="flex flex-wrap items-center gap-2">
                    <!-- Category buttons will be generated here -->
                 </div>
                 <button id="add-classroom-category-btn" class="text-black hover:text-gray-700 font-semibold text-sm underline whitespace-nowrap">+ เพิ่ม</button>
            </div>
    
            <div class="flex-shrink-0 mb-2 flex justify-center items-center relative w-full">
                <p class="text-sm text-gray-600">คลิกที่ชื่อห้องเพื่อ <b class="font-bold">แสดง/ซ่อน</b> จากรายการ</p>
                <div class="absolute right-0 flex gap-4">
                    <button id="show-all-rooms-btn" class="text-sm text-black hover:text-gray-700 underline font-bold">แสดงทั้งหมด</button>
                    <button id="hide-all-rooms-btn" class="text-sm text-gray-500 hover:text-gray-700 underline">ซ่อนทั้งหมด</button>
                </div>
            </div>
    
            <div class="flex-grow relative overflow-auto flex justify-center items-start pt-4">
                 <!-- Main Content Wrapper: Replaced with a vertical flex container -->
                 <div class="inline-flex flex-col items-center gap-[3px]">
                    <!-- Flex container for Grid and Column Controls -->
                    <div class="flex items-center gap-[2px]"> 
                        <div id="classroom-grid-container" class="grid gap-y-1 gap-x-2.5">
                            <!-- Grid will be dynamically generated here -->
                        </div>
        
                        <!-- Column Controls (Flex item) -->
                        <div class="flex items-center bg-white rounded-full p-1 shadow-md border z-10 transform scale-[0.7]">
                            <button id="delete-classroom-col-btn" title="ลบคอลัมน์" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg></button>
                            <div class="border-l my-1 h-4"></div>
                            <button id="add-classroom-col-btn" title="เพิ่มคอลัมน์" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg></button>
                        </div>
                    </div>

                     <!-- Row Controls (Now a flex item, no longer absolutely positioned) -->
                    <div class="flex items-center bg-white rounded-full p-1 shadow-md border z-10 transform scale-[0.7]">
                        <button id="delete-classroom-row-btn" title="ลบแถว" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg></button>
                        <div class="border-l mx-1 h-4"></div>
                        <button id="add-classroom-row-btn" title="เพิ่มแถว" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg></button>
                    </div>
                </div>
            </div>
    
            <div class="flex-shrink-0 flex justify-end gap-2 mt-6 pt-4 border-t">
                <button type="button" id="classroom-names-cancel-btn" class="bg-transparent border border-gray-400 text-gray-600 font-normal hover:bg-gray-100 py-2 px-4 rounded-lg transition-colors">
                    ยกเลิก
                </button>
                <button type="button" id="classroom-names-save-btn" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    บันทึก
                </button>
            </div>
        </div>
    </div>

    <!-- Category Name Modal -->
    <div id="category-name-modal" class="fixed inset-0 z-[60] items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0 bg-gray-900 bg-opacity-60"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/4 max-w-sm relative">
            <h3 class="text-xl font-bold mb-4" id="category-name-modal-title">เปลี่ยนชื่อหมวดหมู่</h3>
            <form id="category-name-form">
                <div class="mb-4">
                    <label for="category-name-input" class="block text-sm font-medium text-gray-700">ชื่อหมวดหมู่</label>
                    <input type="text" id="category-name-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" id="category-name-cancel-btn" class="bg-transparent border border-gray-400 text-gray-600 font-normal hover:bg-gray-100 py-2 px-4 rounded-lg transition-colors">
                        ยกเลิก
                    </button>
                    <button type="submit" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/4 max-w-sm relative">
            <h3 class="text-lg font-bold mb-4">ยืนยันการกระทำ</h3>
            <p id="confirm-message" class="text-gray-700 mb-6">คุณแน่ใจหรือไม่?</p>
            <div class="flex justify-end gap-2">
                <button type="button" id="confirm-cancel-btn" class="bg-transparent border border-gray-400 text-gray-600 font-normal hover:bg-gray-100 py-2 px-4 rounded-lg transition-colors">
                    ยกเลิก
                </button>
                <button type="button" id="confirm-ok-btn" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    ยืนยัน
                </button>
            </div>
        </div>
    </div>
    
    <!-- Major Print Modal Update -->
    <div id="print-modal" class="fixed inset-0 z-50 items-center justify-center hidden bg-gray-900 bg-opacity-60">
        <div class="bg-white rounded-xl shadow-xl w-[95vw] max-w-none h-[95vh] flex overflow-hidden">
            <!-- Left Panel: Control Panel -->
            <div class="w-[320px] flex-shrink-0 bg-white text-black flex flex-col p-6 border-r border-gray-200">
                <h3 class="text-2xl font-bold mb-6">Print</h3>
                
                <div class="mb-6">
                    <h4 class="font-semibold mb-3 text-gray-600">รูปแบบหน้ากระดาษ A4</h4>
                    <div id="print-orientation-selector">
                        <!-- JS will populate orientation buttons -->
                    </div>
                </div>
    
                <div>
                    <h4 class="font-semibold mb-3 text-gray-600">การแสดงผล/หน้า</h4>
                    <div id="print-content-selectors" class="space-y-3">
                        <!-- JS will populate print content rows -->
                    </div>
                </div>
    
                <div class="mt-auto pt-6 border-t border-gray-200 flex justify-end gap-2">
                     <button type="button" id="print-cancel-btn" class="bg-transparent border border-gray-400 text-gray-600 font-normal hover:bg-gray-100 py-2 px-4 rounded-lg transition-colors">
                        ยกเลิก
                    </button>
                    <button type="button" id="print-all-btn" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" class="w-5 h-5" fill="#FFFFFF"><path d="M640-640v-120H320v120h-80v-200h480v200h-80Zm-480 80h640-640Zm560 100q17 0 28.5-11.5T760-500q0-17-11.5-28.5T720-540q-17 0-28.5 11.5T680-500q0 17 11.5 28.5T720-460Zm-80 260v-160H320v160h320Zm80 80H240v-160H80v-240q0-51 35-85.5t85-34.5h560q51 0 85.5 34.5T880-520v240H720v160Zm80-240v-160q0-17-11.5-28.5T760-560H200q-17 0-28.5 11.5T160-520v160h80v-80h480v80h80Z"/></svg>
                        พิมพ์ทั้งหมด
                    </button>
                </div>
            </div>
    
            <!-- Right Panel: Preview (RESTRUCTURED FOR SCALING) -->
            <div class="flex-grow p-6 bg-gray-400 flex flex-col">
                <h4 id="print-preview-title" class="text-lg font-semibold mb-4 text-gray-800 flex-shrink-0">ตัวอย่าง ก่อนพิมพ์ : ทั้งหมด</h4>
                <!-- This is the VIEWPORT that constrains the size -->
                <div id="print-preview-viewport" class="flex-grow flex justify-center items-start overflow-auto p-4 md:p-8">
                    <!-- This is the element that gets SCALED -->
                    <div id="print-preview-scaler" class="space-y-6 md:space-y-8">
                         <!-- JS will render scaled pages here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- Floating Action Button for Printing -->
    <button id="print-fab" class="fixed bottom-6 right-6 bg-black hover:bg-gray-800 text-white rounded-full p-4 shadow-lg transition-transform hover:scale-110">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" class="w-6 h-6" fill="#FFFFFF"><path d="M640-640v-120H320v120h-80v-200h480v200h-80Zm-480 80h640-640Zm560 100q17 0 28.5-11.5T760-500q0-17-11.5-28.5T720-540q-17 0-28.5 11.5T680-500q0 17 11.5 28.5T720-460Zm-80 260v-160H320v160h320Zm80 80H240v-160H80v-240q0-51 35-85.5t85-34.5h560q51 0 85.5 34.5T880-520v240H720v160Zm80-240v-160q0-17-11.5-28.5T760-560H200q-17 0-28.5 11.5T160-520v160h80v-80h480v80h80Z"/></svg>
    </button>
    
    <!-- Temporary container for printing content -->
    <div id="print-container"></div>


    <script>
        // --- STATE & DOM ---
        let buildingsList = [], selectedBuildingIndex = parseInt(localStorage.getItem('selectedBuildingIndex'), 10) || 0;
        let currentBuildingData = { grid: [], rowSettings: [] };
        let selectedRoom = { floor: 0, room: 0 };
        let selectedRoomTypeInModal = 'classroom';
        let isMergeMode = false, selectedForMerge = [];
        let dragState = { isDragging: false };
        let history = [], historyIndex = -1;
        let buildingModalState = { visible: false, mode: 'add', index: -1 };
        let globalAssignedClassrooms = new Set();
        
        // --- PRINTING STATE ---
        let printOrientation = 'landscape'; // Initial view set to landscape per request
        let printQuantities = { layout: 1, studentSummary: 1, buildingSummary: 1 }; // Initial amounts set to 1 per request
        let selectedPrintPreviewType = 'layout'; // Optimized: Default preview to layout
        let previewResizeObserver; // For scaling the preview
        
        // --- NEW CLASSROOM MANAGEMENT STATE ---
        let classroomData = { categories: [], grids: {} };
        let selectedClassroomCategoryIndex = 0;
        let categoryModalState = { visible: false, mode: 'add', index: -1 };
        let tempClassroomData; // For editing within the modal
        let selectedSummaryCategoryIndex = -1; // -1 for "All"

        // --- WORKFLOW STATE ---
        let shouldPreserveScroll = false;
        let lastScrollY = 0;
        let shouldScrollToTop = false;


        const dom = {
            buildingButtons: document.getElementById('building-buttons'),
            buildingContent: document.getElementById('building-content'),
            loader: document.getElementById('loader'),
            buildingTitle: document.getElementById('building-title'),
            roomGridContainer: document.getElementById('room-grid-container'),
            modal: document.getElementById('edit-modal'),
            modalTitle: document.getElementById('modal-title'),
            editForm: document.getElementById('edit-form'),
            editFieldset: document.getElementById('edit-fieldset'),
            roomId: document.getElementById('room-id'),
            roomNameContainer: document.getElementById('room-name-container'),
            roomNameSelect: document.getElementById('room-name-select'),
            roomNameInput: document.getElementById('room-name-input'),
            roomDetails: document.getElementById('room-details'),
            roomTypeSelector: document.getElementById('room-type-selector'),
            cancelButton: document.getElementById('cancel-button'),
            addRowBtn: document.getElementById('add-row-btn'),
            deleteRowBtn: document.getElementById('delete-row-btn'),
            addColBtn: document.getElementById('add-col-btn'),
            deleteColBtn: document.getElementById('delete-col-btn'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmOkBtn: document.getElementById('confirm-ok-btn'),
            confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
            confirmMessage: document.getElementById('confirm-message'),
            deleteDataButton: document.getElementById('delete-data-button'),
            toast: document.getElementById('toast-notification'),
            toastMessage: document.getElementById('toast-message'),
            toggleMergeBtn: document.getElementById('toggle-merge-mode-btn'),
            mergeActions: document.getElementById('merge-actions'),
            confirmMergeBtn: document.getElementById('confirm-merge-btn'),
            cancelMergeBtn: document.getElementById('cancel-merge-btn'),
            normalModeControls: document.getElementById('normal-mode-controls'),
            unmergeBtn: document.getElementById('unmerge-button'),
            undoBtn: document.getElementById('undo-btn'),
            redoBtn: document.getElementById('redo-btn'),
            buildingModal: document.getElementById('building-modal'),
            buildingModalTitle: document.getElementById('building-modal-title'),
            buildingForm: document.getElementById('building-form'),
            buildingNameInput: document.getElementById('building-name-input'),
            buildingCancelBtn: document.getElementById('building-cancel-btn'),
            resetBuildingBtn: document.getElementById('reset-building-btn'),
            classroomCount: document.getElementById('classroom-count'),
            labCount: document.getElementById('lab-count'),
            officeCount: document.getElementById('office-count'),
            renovationCount: document.getElementById('renovation-count'),
            vacantCount: document.getElementById('vacant-count'),
            studentRoomSummaryContainer: document.getElementById('student-room-summary-container'),
            studentRoomSummarySelector: document.getElementById('student-room-summary-selector'),
            buildingSummarySelector: document.getElementById('building-summary-selector'),
            buildingSummaryTableContainer: document.getElementById('building-summary-table-container'),
            registerRoomCard: document.getElementById('register-room-card'),
            // --- NEW CLASSROOM MODAL DOM ELEMENTS ---
            manageClassroomsBtn: document.getElementById('manage-classrooms-btn'),
            classroomNamesModal: document.getElementById('classroom-names-modal'),
            classroomNamesCancelBtn: document.getElementById('classroom-names-cancel-btn'),
            classroomNamesSaveBtn: document.getElementById('classroom-names-save-btn'),
            classroomCategoryButtons: document.getElementById('classroom-category-buttons'),
            addClassroomCategoryBtn: document.getElementById('add-classroom-category-btn'),
            showAllRoomsBtn: document.getElementById('show-all-rooms-btn'),
            hideAllRoomsBtn: document.getElementById('hide-all-rooms-btn'),
            classroomGridContainer: document.getElementById('classroom-grid-container'),
            addClassroomColBtn: document.getElementById('add-classroom-col-btn'),
            deleteClassroomColBtn: document.getElementById('delete-classroom-col-btn'),
            addClassroomRowBtn: document.getElementById('add-classroom-row-btn'),
            deleteClassroomRowBtn: document.getElementById('delete-classroom-row-btn'),
            categoryNameModal: document.getElementById('category-name-modal'),
            categoryNameModalTitle: document.getElementById('category-name-modal-title'),
            categoryNameForm: document.getElementById('category-name-form'),
            categoryNameInput: document.getElementById('category-name-input'),
            categoryNameCancelBtn: document.getElementById('category-name-cancel-btn'),
            // --- PRINT MODAL DOM ELEMENTS (UPDATED) ---
            printFab: document.getElementById('print-fab'),
            printModal: document.getElementById('print-modal'),
            printCancelBtn: document.getElementById('print-cancel-btn'),
            printAllBtn: document.getElementById('print-all-btn'),
            printPreviewViewport: document.getElementById('print-preview-viewport'),
            printPreviewTitle: document.getElementById('print-preview-title'),
            printContainer: document.getElementById('print-container'),
            printOrientationSelector: document.getElementById('print-orientation-selector'),
            printFilterButtons: document.getElementById('print-filter-buttons'),
            printContentSelectors: document.getElementById('print-content-selectors'),
        };
        
        const ROOM_TYPES = {
            classroom: 'ห้องเรียน',
            lab: 'ห้องปฏิบัติการ(LAB)',
            office: 'ห้องสำนักงาน',
            renovation: 'ปิดปรับปรุง',
            vacant: 'ห้องว่าง',
        };

        let toastTimeout;
        const createNewRoom = () => ({ id: '', name: 'ว่าง', details: '- - -', mergeInfo: null, type: 'vacant' });
        
        // --- UI UTILS ---
        function naturalSort(a, b) {
            const re = /(\d+)/g;
            const aParts = a.split(re);
            const bParts = b.split(re);

            for (let i = 0; i < Math.min(aParts.length, bParts.length); i++) {
                const partA = aParts[i];
                const partB = bParts[i];

                if (i % 2 === 1) { // It's a number part
                    const numA = parseInt(partA, 10);
                    const numB = parseInt(partB, 10);
                    if (numA !== numB) {
                        return numA - numB;
                    }
                } else { // It's a string part
                    if (partA !== partB) {
                        return partA.localeCompare(partB, 'th');
                    }
                }
            }
            return a.length - b.length;
        }
        
        function showToast(message, isError = true) {
            clearTimeout(toastTimeout);
            dom.toastMessage.textContent = message;
            dom.toast.classList.toggle('bg-red-500', isError);
            dom.toast.classList.toggle('bg-green-500', !isError);
            dom.toast.classList.remove('hidden');
            toastTimeout = setTimeout(() => dom.toast.classList.add('hidden'), 3000);
        }
        const showLoader = (isLoading) => {
            dom.loader.classList.toggle('hidden', !isLoading);
            dom.buildingContent.classList.toggle('hidden', isLoading);
        };

        // --- HISTORY MANAGEMENT ---
        function updateUndoRedoButtons() {
            dom.undoBtn.disabled = historyIndex <= 0;
            dom.redoBtn.disabled = historyIndex >= history.length - 1;
        }

        function initializeHistory(initialData) {
            history = [JSON.parse(JSON.stringify(initialData))];
            historyIndex = 0;
            updateUndoRedoButtons();
        }

        function pushToHistory(newData) {
            history = history.slice(0, historyIndex + 1);
            history.push(JSON.parse(JSON.stringify(newData)));
            historyIndex++;
            updateUndoRedoButtons();
        }

        function handleUndo() {
            if (historyIndex <= 0) return;
            lastScrollY = window.scrollY;
            shouldPreserveScroll = true;
            historyIndex--;
            const prevState = JSON.parse(JSON.stringify(history[historyIndex]));
            currentBuildingData = prevState;
            saveData(prevState);
            updateUndoRedoButtons();
            // Re-render after state change
            renderAll();
        }

        function handleRedo() {
            if (historyIndex >= history.length - 1) return;
            lastScrollY = window.scrollY;
            shouldPreserveScroll = true;
            historyIndex++;
            const nextState = JSON.parse(JSON.stringify(history[historyIndex]));
            currentBuildingData = nextState;
            saveData(nextState);
            updateUndoRedoButtons();
             // Re-render after state change
            renderAll();
        }

        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderRoomGrid();
            renderSummaryCard();
            renderBuildingSummaryCard();
            renderStudentRoomSummary();
        }

        function renderSummaryCard() {
            const totalCounts = {
                classroom: 0, lab: 0, office: 0, renovation: 0, vacant: 0,
            };

            const allBuildingsData = buildingsList.map(building => getBuildingData(building.id));

            for (const buildingData of allBuildingsData) {
                if (buildingData && buildingData.grid) {
                    buildingData.grid.flat().forEach(room => {
                        if (totalCounts.hasOwnProperty(room.type)) {
                            totalCounts[room.type]++;
                        }
                    });
                }
            }

            dom.classroomCount.textContent = totalCounts.classroom;
            dom.labCount.textContent = totalCounts.lab;
            dom.officeCount.textContent = totalCounts.office;
            dom.renovationCount.textContent = totalCounts.renovation;
            dom.vacantCount.textContent = totalCounts.vacant;
        }

        function getVisibleClassroomNames() {
            if (!classroomData || !classroomData.grids) return [];
            const visibleNames = new Set();
            Object.values(classroomData.grids).forEach(gridData => {
                if (gridData && gridData.grid) {
                    gridData.grid.flat().forEach(room => {
                        if (room && room.name && !room.hidden) {
                            visibleNames.add(room.name);
                        }
                    });
                }
            });
            return [...visibleNames].sort(naturalSort);
        }
        
        function renderStudentRoomSummary() {
            const selectorContainer = dom.studentRoomSummarySelector;
            const container = dom.studentRoomSummaryContainer;
            selectorContainer.innerHTML = '';
            container.innerHTML = '';

            // 1. Determine which categories have visible rooms
            const visibleCategories = classroomData.categories.map((cat, index) => {
                const gridData = classroomData.grids[cat.id];
                const hasVisibleItems = gridData?.grid?.flat().some(room => room && room.name && !room.hidden);
                return hasVisibleItems ? { ...cat, originalIndex: index } : null;
            }).filter(Boolean); // Filter out nulls

            // 2. Render category selector buttons if needed
            if (visibleCategories.length > 0) {
                // "All" button
                const allBtn = document.createElement('button');
                allBtn.className = `px-3 py-1.5 text-sm rounded-full transition-colors ${ selectedSummaryCategoryIndex === -1 ? 'bg-black text-white font-bold' : 'bg-transparent text-gray-500 font-normal border border-gray-400 hover:bg-gray-100'}`;
                allBtn.textContent = 'ทั้งหมด';
                allBtn.onclick = () => {
                    if (selectedSummaryCategoryIndex !== -1) {
                        selectedSummaryCategoryIndex = -1;
                        renderStudentRoomSummary();
                    }
                };
                selectorContainer.appendChild(allBtn);

                // Category-specific buttons
                visibleCategories.forEach(cat => {
                    const button = document.createElement('button');
                    const isSelected = selectedSummaryCategoryIndex === cat.originalIndex;
                    button.className = `px-3 py-1.5 text-sm rounded-full transition-colors ${ isSelected ? 'bg-black text-white font-bold' : 'bg-transparent text-gray-500 font-normal border border-gray-400 hover:bg-gray-100'}`;
                    button.textContent = cat.name;
                    button.onclick = () => {
                        if (selectedSummaryCategoryIndex !== cat.originalIndex) {
                            selectedSummaryCategoryIndex = cat.originalIndex;
                            renderStudentRoomSummary();
                        }
                    };
                    selectorContainer.appendChild(button);
                });
            }

            // 3. Determine which classrooms to display based on selection
            let classroomsToDisplay;
            if (selectedSummaryCategoryIndex === -1) {
                classroomsToDisplay = getVisibleClassroomNames();
            } else {
                const selectedCategory = classroomData.categories[selectedSummaryCategoryIndex];
                if (selectedCategory && classroomData.grids[selectedCategory.id]) {
                    classroomsToDisplay = classroomData.grids[selectedCategory.id].grid
                        .flat()
                        .filter(room => room && room.name && !room.hidden)
                        .map(room => room.name)
                        .sort(naturalSort);
                } else {
                    classroomsToDisplay = [];
                }
            }

            if (classroomsToDisplay.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full text-center">ไม่มีห้องเรียนที่แสดงในหมวดหมู่นี้</p>';
                return;
            }

            // 4. Proceed with existing rendering logic using `classroomsToDisplay`
            const studentRoomsData = {};
            const allBuildingsData = buildingsList.map(building => getBuildingData(building.id));

            allBuildingsData.forEach((buildingData, buildingIndex) => {
                 if (buildingData && buildingData.grid) {
                    buildingData.grid.forEach((floor, floorIndex) => {
                        floor.forEach((room, roomIndex) => {
                            if ((room.type === 'classroom' || room.type === 'lab') && classroomsToDisplay.includes(room.name)) {
                               studentRoomsData[room.name] = { ...room, _buildingIndex: buildingIndex, _floorIndex: floorIndex, _roomIndex: roomIndex };
                            }
                        });
                    });
                }
            });
            
            const groupedClassrooms = classroomsToDisplay.reduce((acc, name) => {
                const prefixMatch = name.match(/^([^\d]+)(\d*)/);
                const prefix = prefixMatch ? (prefixMatch[1].trim() + (prefixMatch[2] ? ` ${prefixMatch[2]}` : '')).trim() : 'อื่น ๆ';
                if (!acc[prefix]) acc[prefix] = [];
                acc[prefix].push(name);
                return acc;
            }, {});


            const fragment = document.createDocumentFragment();
            
            for (const groupName in groupedClassrooms) {
                const gradeContainer = document.createElement('div');
                gradeContainer.className = 'flex-shrink-0 bg-gray-50 rounded-md border border-gray-200';

                const header = document.createElement('div');
                header.className = 'font-bold bg-gray-200 px-2 py-1 rounded-t-md grid grid-cols-2 gap-2';
                header.innerHTML = `<div>${groupName}</div><div>รหัสห้อง</div>`;
                gradeContainer.appendChild(header);

                groupedClassrooms[groupName].forEach(className => {
                    const roomData = studentRoomsData[className];
                    const row = document.createElement('div');
                    
                    let rowBgClass = (roomData && roomData.type === 'lab') ? 'bg-yellow-50' : 'bg-white';
                    const roomId = roomData ? (roomData.id || `${roomData._buildingIndex + 1} ${roomData._floorIndex + 1} ${roomData._roomIndex + 1}`) : '-';
                    const roomIdCellClasses = !roomData ? 'bg-zinc-700 text-white text-center rounded' : 'text-gray-600';
                    
                    row.className = `grid grid-cols-2 gap-2 px-2 py-0.5 items-center border-t border-gray-200 transition-colors hover:bg-gray-100 ${rowBgClass}`;
                    row.innerHTML = `<div class="font-semibold">${className}</div><div class="${roomIdCellClasses}">${roomId}</div>`;
                    gradeContainer.appendChild(row);
                });
                
                fragment.appendChild(gradeContainer);
            }
            
            container.appendChild(fragment);
        }

        function renderBuildingSummaryCard() {
            const selectorContainer = dom.buildingSummarySelector;
            selectorContainer.innerHTML = '';

            buildingsList.forEach((building, i) => {
                const button = document.createElement('button');
                const isSelected = i === selectedBuildingIndex;
                button.className = `px-3 py-1.5 text-sm rounded-full transition-colors ${ isSelected ? 'bg-black text-white font-bold' : 'bg-transparent text-gray-500 font-normal border border-gray-400 hover:bg-gray-100'}`;
                button.textContent = building.name;
                button.onclick = () => {
                    if (selectedBuildingIndex !== i) {
                        selectedBuildingIndex = i;
                        localStorage.setItem('selectedBuildingIndex', selectedBuildingIndex);
                        if (isMergeMode) toggleMergeMode();
                        lastScrollY = window.scrollY;
                        shouldPreserveScroll = true;
                        renderBuildingSelector(); 
                        renderBuildingSummaryCard(); 
                        loadBuildingData(buildingsList[selectedBuildingIndex].id);
                    }
                };
                selectorContainer.appendChild(button);
            });
            
            const container = dom.buildingSummaryTableContainer;
            
            if (!buildingsList || buildingsList.length === 0 || selectedBuildingIndex < 0) {
                container.innerHTML = '<p class="text-gray-500">กรุณาเลือกตึกเพื่อดูสรุป</p>';
                return;
            }

            const buildingInfo = buildingsList[selectedBuildingIndex];
            
            container.innerHTML = `<div class="loader mx-auto"></div>`;
            container.className = 'overflow-x-auto relative';

            try {
                const buildingData = getBuildingData(buildingInfo.id);

                container.innerHTML = ''; // Clear loader

                if (!buildingData || !buildingData.grid || buildingData.grid.length === 0) {
                    container.innerHTML = `<p class="text-gray-500">ไม่มีข้อมูลสำหรับตึกนี้</p>`;
                    return;
                }
                
                const mainGridContainer = document.createElement('div');
                mainGridContainer.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4';

                const grid = buildingData.grid;
                const numFloors = grid.length;
                const maxRooms = Math.max(0, ...grid.map(floor => floor.length));

                for (let floorIndex = 0; floorIndex < numFloors; floorIndex++) {
                    const floorWrapper = document.createElement('div');
                    floorWrapper.className = 'bg-white border border-gray-300 rounded-md overflow-hidden flex flex-col';

                    const table = document.createElement('table');
                    table.className = 'text-xs w-full';

                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr>
                            <th colspan="3" class="px-4 py-2 text-center text-xs text-gray-700 uppercase bg-gray-100 border-b border-gray-300">ชั้น ${floorIndex + 1}</th>
                        </tr>
                        <tr>
                            <th class="px-2 py-1 font-medium text-gray-600 bg-gray-50 border-b border-gray-300 text-center">เลขห้อง</th>
                            <th class="px-2 py-1 font-medium text-gray-600 bg-gray-50 border-b border-gray-300 text-center">ชื่อห้อง</th>
                            <th class="px-2 py-1 font-medium text-gray-600 bg-gray-50 border-b border-gray-300 text-center">รายละเอียด</th>
                        </tr>
                    `;
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');
                    for (let roomIndex = 0; roomIndex < maxRooms; roomIndex++) {
                        const room = grid[floorIndex] ? grid[floorIndex][roomIndex] : null;
                        const row = tbody.insertRow();
                        
                        if (room) {
                            let rowClasses = 'transition-colors';
                            switch (room.type) {
                                case 'lab':       rowClasses += ' bg-yellow-50 hover:bg-yellow-100'; break;
                                case 'office':    rowClasses += ' bg-slate-100 hover:bg-slate-200'; break;
                                case 'renovation':rowClasses += ' bg-red-100 text-red-800 hover:bg-red-200'; break;
                                default:          rowClasses += ' bg-white hover:bg-gray-50';
                            }
                             row.className = rowClasses;

                            const buildingStr = (selectedBuildingIndex + 1).toString();
                            const floorStr = (floorIndex + 1).toString();
                            const roomStr = (roomIndex + 1).toString();
                            const defaultRoomId = `${buildingStr} ${floorStr} ${roomStr}`;
                            
                            row.innerHTML = `
                                <td class="px-2 py-1 border-t border-gray-200 whitespace-nowrap align-middle">${room.id || defaultRoomId}</td>
                                <td class="px-2 py-1 border-t border-gray-200 align-middle">${room.name || '-'}</td>
                                <td class="px-2 py-1 border-t border-gray-200 align-middle">${room.details || '-'}</td>
                            `;
                        } else {
                                row.className = 'bg-gray-50 h-[30px]'; // Empty row placeholder
                                row.innerHTML = `
                                <td class="px-2 py-1 border-t border-gray-200">-</td>
                                <td class="px-2 py-1 border-t border-gray-200">-</td>
                                <td class="px-2 py-1 border-t border-gray-200">-</td>
                            `;
                        }
                    }
                    table.appendChild(tbody);
                    floorWrapper.appendChild(table);
                    mainGridContainer.appendChild(floorWrapper);
                }
                
                container.appendChild(mainGridContainer);

            } catch (error) {
                console.error("Error rendering new building summary layout:", error);
                container.innerHTML = `<p class="text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูลอาคาร</p>`;
            }
        }

        function renderRoomGrid() {
            const buildingName = buildingsList[selectedBuildingIndex]?.name || '';
            dom.buildingTitle.textContent = buildingName;
            const building = currentBuildingData.grid;
            const gridContainer = dom.roomGridContainer;
            gridContainer.innerHTML = '';
            
            if (!building || building.length === 0) return;

            const numCols = building[0] ? building[0].length : 0;
            if (numCols === 0) return;

            // --- Start: Floor Label and Table of Room Register (FL,RR table) ---
            
            // 1. Setup the main container with a grid layout and a gap for spacing.
            gridContainer.className = 'grid';
            gridContainer.style.gridTemplateColumns = 'auto 1fr';
            gridContainer.style.columnGap = '1rem';

            const reversedBuilding = [...building].reverse();
            const numRows = reversedBuilding.length;

            // 2. Create two main columns: one for labels, one for rooms.
            const labelsColumn = document.createElement('div');
            labelsColumn.className = 'grid'; // Use grid for labels to align with room rows.
            labelsColumn.style.gridTemplateRows = `repeat(${numRows}, 1fr)`;

            const roomsColumn = document.createElement('div');
            // 3. Apply border, radius, and overflow to the single rooms container to fix the corner bug.
            roomsColumn.className = 'border border-gray-800 rounded-lg overflow-hidden flex flex-col';

            reversedBuilding.forEach((floor, reversedFloorIndex) => {
                const floorIndex = building.length - 1 - reversedFloorIndex;
                const rowSettings = currentBuildingData.rowSettings[floorIndex];
                if (!rowSettings) return;

                // --- Create and append the floor label to its column ---
                const labelContainer = document.createElement('div');
                labelContainer.className = 'flex items-center justify-center text-gray-700 font-normal text-sm px-4';
                labelContainer.textContent = `ชั้น ${floorIndex + 1}`;
                labelsColumn.appendChild(labelContainer);

                // --- Create the container for a single row of rooms ---
                const rowContainer = document.createElement('div');
                rowContainer.className = 'relative flex-grow'; // flex-grow helps rows share height equally.
                
                // Add a top border to create dividers between rows.
                if (reversedFloorIndex > 0) {
                    rowContainer.classList.add('border-t', 'border-gray-800');
                }

                const rowGrid = document.createElement('div');
                rowGrid.className = 'grid divide-x divide-gray-800 h-full';
                rowGrid.style.gridTemplateColumns = rowSettings.columnWidths.map(w => `${w}%`).join(' ');

                for (let roomIndex = 0; roomIndex < floor.length; roomIndex++) {
                    const room = floor[roomIndex];
                    if (room.mergeInfo && room.mergeInfo.isMerged && !room.mergeInfo.isPrimary) continue;

                    const cell = document.createElement('div');
                    // Add a minimum height to ensure rows are not too short.
                    cell.className = 'py-1 px-2 flex flex-col justify-center text-center transition-all h-full min-h-[5rem]';
                    cell.dataset.floor = floorIndex; cell.dataset.room = roomIndex;

                    if (room.mergeInfo && room.mergeInfo.isPrimary) cell.style.gridColumn = `span ${room.mergeInfo.span}`;
                    
                    const isSelected = selectedForMerge.some(s => s.floor === floorIndex && s.room === roomIndex);
                    if (isMergeMode) {
                        if(!room.mergeInfo) cell.classList.add('cursor-pointer', 'hover:bg-indigo-100');
                        if (isSelected) cell.classList.add('ring-2', 'ring-indigo-500', 'z-10');
                    } else {
                        cell.classList.add('cursor-pointer', 'hover:bg-indigo-50');
                    }
                    
                    if (room.type === 'office') cell.classList.add('bg-gray-400');
                    else if (room.type === 'renovation') cell.classList.add('bg-red-600', 'text-white', 'hover:text-black', 'items-center');
                    else if (room.type === 'lab') {
                        cell.classList.add('bg-yellow-200');
                        if (room.name === 'ว่าง') cell.classList.add('border', 'border-dashed', 'border-gray-400');
                    } else if (room.type === 'vacant') cell.classList.add('bg-slate-200', 'border', 'border-dashed', 'border-gray-400');
                    else cell.classList.add('bg-gray-50');

                    const buildingStr = (selectedBuildingIndex + 1).toString();
                    const floorStr = (floorIndex + 1).toString();
                    const roomStr = (roomIndex + 1).toString();
                    const defaultRoomId = `${buildingStr} ${floorStr} ${roomStr}`;

                    cell.innerHTML = room.type === 'renovation' 
                        ? `<div class="font-bold text-sm truncate" title="${room.id || defaultRoomId}">${room.id || defaultRoomId}</div><div class="font-semibold text-xs truncate">ปิดปรับปรุง</div><div class="text-[11px] text-gray-200 truncate mt-1">- - -</div>`
                        : `<div class="font-bold text-sm truncate" title="${room.id || defaultRoomId}">${room.id || defaultRoomId}</div><div class="font-semibold text-xs truncate" title="${room.name || 'N/A'}">${room.name || 'N/A'}</div><div class="text-[11px] text-gray-500 truncate mt-1" title="${room.details || ''}">${room.details || ''}</div>`;

                    cell.onclick = () => isMergeMode ? handleCellSelectForMerge(floorIndex, roomIndex) : openModal(floorIndex, roomIndex);
                    rowGrid.appendChild(cell);
                }
                
                const resizerContainer = document.createElement('div');
                resizerContainer.className = 'absolute top-0 bottom-0 left-0 right-0 pointer-events-none';
                renderRowResizers(floorIndex, resizerContainer);

                rowContainer.appendChild(rowGrid);
                rowContainer.appendChild(resizerContainer);
                
                roomsColumn.appendChild(rowContainer);
            });

            // 4. Append the fully constructed columns to the main grid container.
            gridContainer.appendChild(labelsColumn);
            gridContainer.appendChild(roomsColumn);

            // --- End: Floor Label and Table of Room Register (FL,RR table) ---
        }

        function renderRowResizers(floorIndex, container) {
            container.innerHTML = '';
            let cumulativeWidth = 0;
            const widths = currentBuildingData.rowSettings[floorIndex].columnWidths;
            if (!widths) return;

            for (let i = 0; i < widths.length - 1; i++) {
                cumulativeWidth += widths[i];
                const resizer = document.createElement('div');
                resizer.className = 'resizer';
                resizer.style.left = `${cumulativeWidth}%`;
                resizer.onmousedown = (e) => handleDragStart(e, floorIndex, i);
                container.appendChild(resizer);
            }
        }
        
        function renderBuildingSelector() {
            let buttonsHTML = buildingsList.map((building, i) => {
                const isSelected = i === selectedBuildingIndex;
                const buttonClasses = `px-3 py-1.5 text-sm rounded-full transition-colors ${ isSelected ? 'bg-black text-white font-bold' : 'bg-transparent text-gray-500 font-normal border border-gray-400 hover:bg-gray-100'}`;
                
                return `
                <div class="relative group">
                    <button data-building-index="${i}" class="${buttonClasses} w-full text-left pr-10">
                        ${building.name}
                    </button>
                    <div class="absolute top-1/2 right-1.5 -translate-y-1/2 flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button data-action="rename" data-index="${i}" title="เปลี่ยนชื่อ" class="p-0.5 rounded-full hover:bg-gray-200">
                            <svg class="w-3.5 h-3.5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                        </button>
                        <button data-action="delete" data-index="${i}" title="ลบ" class="p-0.5 rounded-full hover:bg-gray-200">
                            <svg class="w-3.5 h-3.5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                        </button>
                    </div>
                </div>`;
            }).join('');

            buttonsHTML += `<button data-action="add" class="text-black hover:text-gray-700 font-semibold text-sm underline whitespace-nowrap">+ เพิ่มตึก</button>`;
            
            dom.buildingButtons.innerHTML = buttonsHTML;

            dom.buildingButtons.onclick = (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const action = button.dataset.action;
                
                if (action === 'add') {
                    openBuildingModal('add');
                    return;
                }

                const indexStr = button.dataset.index || button.closest('[data-building-index]')?.dataset.buildingIndex;
                
                if (action === 'rename' || action === 'delete') {
                    e.stopPropagation();
                    const index = parseInt(indexStr, 10);
                    if (action === 'rename') openBuildingModal('rename', index);
                    else handleDeleteBuilding(index);
                } else if (indexStr) {
                    const index = parseInt(indexStr, 10);
                    if (selectedBuildingIndex !== index) {
                        selectedBuildingIndex = index;
                        localStorage.setItem('selectedBuildingIndex', selectedBuildingIndex);
                        if (isMergeMode) toggleMergeMode();
                        shouldScrollToTop = true; 
                        renderBuildingSelector();
                        renderBuildingSummaryCard(); 
                        loadBuildingData(buildingsList[selectedBuildingIndex].id);
                    }
                }
            };
        }
        
        // --- MODAL & CONFIRMATION ---
        function renderRoomTypeSelector(activeType) {
            const container = dom.roomTypeSelector;
            container.innerHTML = '';
            Object.entries(ROOM_TYPES).forEach(([type, label]) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.type = type;
                const isSelected = type === activeType;
                button.className = `room-type-btn transition-colors py-1 px-3 rounded-full text-sm ${ isSelected ? 'bg-black text-white font-bold' : 'bg-transparent text-gray-500 font-normal border border-gray-400 hover:bg-gray-100' }`;
                button.textContent = label;
                container.appendChild(button);
            });
            dom.editFieldset.disabled = activeType === 'renovation';
        }

        function updateGlobalAssignedClassrooms() {
            globalAssignedClassrooms.clear();
            const allBuildingsData = buildingsList.map(building => getBuildingData(building.id));
            const allVisibleClassrooms = getVisibleClassroomNames();

            for (const buildingData of allBuildingsData) {
                if (buildingData && buildingData.grid) {
                    buildingData.grid.flat().forEach(room => {
                        if ((room.type === 'classroom' || room.type === 'lab') && allVisibleClassrooms.includes(room.name)) {
                            globalAssignedClassrooms.add(room.name);
                        }
                    });
                }
            }
        }

        function populateRoomNameDatalist(currentRoomName = '') {
            dom.roomNameSelect.innerHTML = '';
            
            const availableRooms = getVisibleClassroomNames().filter(name => !globalAssignedClassrooms.has(name) || name === currentRoomName);
            
            availableRooms.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if(name === currentRoomName) {
                    option.selected = true;
                }
                dom.roomNameSelect.appendChild(option);
            });
        }
        
        function updateRoomNameUI(roomType, initialRoomData = {}) {
            const isSelectVisible = roomType === 'classroom' || roomType === 'lab';
            dom.roomNameSelect.classList.toggle('hidden', !isSelectVisible);
            dom.roomNameInput.classList.toggle('hidden', isSelectVisible);

            let roomNameValue = initialRoomData.name || '';
            let roomDetailsValue = initialRoomData.details || '';

            switch (roomType) {
                case 'lab':
                    if(!initialRoomData.details) roomDetailsValue = 'LAB...';
                    break;
                case 'office':
                    if(!initialRoomData.name) roomNameValue = 'สำนักงาน...';
                    if(!initialRoomData.details) roomDetailsValue = '- - -';
                    break;
                case 'renovation':
                    roomNameValue = 'ปิดปรับปรุง';
                    roomDetailsValue = '- - -';
                    break;
                case 'vacant':
                    roomNameValue = 'ว่าง';
                    roomDetailsValue = '- - -';
                    break;
            }

            if (isSelectVisible) {
                populateRoomNameDatalist(roomNameValue);
            } else {
                dom.roomNameInput.value = roomNameValue;
            }
            dom.roomDetails.value = roomDetailsValue;
        }

        function openModal(floorIdx, roomIdx) {
            let roomData = currentBuildingData.grid[floorIdx][roomIdx];
            if (roomData.mergeInfo && !roomData.mergeInfo.isPrimary) {
                const primary = roomData.mergeInfo.primaryCell;
                floorIdx = primary.floor; roomIdx = primary.room;
                roomData = currentBuildingData.grid[floorIdx][roomIdx];
            }
            selectedRoom = { floor: floorIdx, room: roomIdx };
            
            const buildingName = buildingsList[selectedBuildingIndex]?.name || '';
            dom.modalTitle.textContent = `แก้ไขข้อมูลห้อง: ${buildingName}, ชั้น ${floorIdx + 1}, ห้อง ${roomIdx + 1}`;
            
            selectedRoomTypeInModal = roomData.type || 'classroom';
            renderRoomTypeSelector(selectedRoomTypeInModal);
            
            updateRoomNameUI(selectedRoomTypeInModal, roomData);

            const buildingStr = (selectedBuildingIndex + 1).toString();
            const floorStr = (floorIdx + 1).toString();
            const roomStr = (roomIdx + 1).toString();
            const defaultRoomId = `${buildingStr} ${floorStr} ${roomStr}`;

            dom.roomId.value = roomData.id || defaultRoomId;
            
            const isPrimaryMerged = roomData.mergeInfo && roomData.mergeInfo.isPrimary;
            dom.unmergeBtn.classList.toggle('hidden', !isPrimaryMerged);
            
            dom.modal.classList.add('flex'); dom.modal.classList.remove('hidden');
        }
        const closeModal = () => { dom.modal.classList.add('hidden'); dom.modal.classList.remove('flex'); };
        function showConfirmation(message, onConfirm) {
            dom.confirmMessage.textContent = message;
            dom.confirmModal.classList.remove('hidden'); dom.confirmModal.classList.add('flex');
            dom.confirmOkBtn.onclick = () => { onConfirm(); hideConfirmation(); };
        }
        const hideConfirmation = () => { dom.confirmModal.classList.add('hidden'); dom.confirmModal.classList.remove('flex'); };

        // --- DATA & LOCAL STORAGE ---
        function getBuildingData(buildingId) {
            if (!buildingId) return null;
            const data = localStorage.getItem(`building_${buildingId}`);
            return data ? JSON.parse(data) : null;
        }

        function loadClassroomData() {
            const data = localStorage.getItem('classroomData');
            if (data) {
                classroomData = JSON.parse(data);
            } else {
                // Create initial data if it doesn't exist
                const initialData = {
                    categories: [
                        { id: 'cat_0', name: 'อนุบาล' },
                        { id: 'cat_1', name: 'ประถม' },
                        { id: 'cat_2', name: 'มัธยม' },
                    ],
                    grids: {
                        'cat_0': { grid: Array.from({ length: 10 }, (_, r) => Array.from({ length: 3 }, (_, c) => ({ name: `อ.${c + 1}/${r + 1}`, hidden: true }))) },
                        'cat_1': { grid: Array.from({ length: 10 }, (_, r) => Array.from({ length: 6 }, (_, c) => ({ name: `ป.${c + 1}/${r + 1}`, hidden: true }))) },
                        'cat_2': { grid: Array.from({ length: 15 }, (_, r) => Array.from({ length: 6 }, (_, c) => ({ name: `ม.${c + 1}/${r + 1}`, hidden: false }))) },
                    }
                };
                localStorage.setItem('classroomData', JSON.stringify(initialData));
                classroomData = initialData;
            }
            // Ensure selected index is valid
            if (selectedClassroomCategoryIndex >= classroomData.categories.length) {
                selectedClassroomCategoryIndex = 0;
            }
        }
        
        function loadBuildingsList() {
            const data = localStorage.getItem('buildingsList');

            if (!data || JSON.parse(data).length === 0) {
                 const defaultList = [];
                const numBuildings = 10;
                const numRows = 6;
                const numCols = 15;

                const classroomPoolCopy = getVisibleClassroomNames();
                
                const labRoomName = 'ม.1/1';
                const labRoomIndex = classroomPoolCopy.indexOf(labRoomName);
                if (labRoomIndex > -1) {
                    classroomPoolCopy.splice(labRoomIndex, 1);
                }

                let classroomCursor = 0;

                for (let i = 0; i < numBuildings; i++) {
                    const newBuildingId = `bldg_${Date.now()}_${i}`;
                    defaultList.push({ id: newBuildingId, name: `ตึก ${i + 1}` });

                    const defaultWidths = Array(numCols).fill(100 / numCols);
                    
                    const newGrid = Array.from({ length: numRows }, (_, floorIndex) => {
                        return Array.from({ length: numCols }, (_, roomIndex) => {
                            const newRoom = createNewRoom();

                            if (i === 0) {
                                if (floorIndex === 0) {
                                    if (roomIndex <= 3) {
                                        newRoom.type = 'office'; newRoom.name = 'สำนักงาน'; newRoom.details = `ห้องสำนักงาน ${roomIndex + 1}`;
                                    } else if (roomIndex <= 6) {
                                        newRoom.type = 'vacant';
                                    } else {
                                        newRoom.type = 'renovation'; newRoom.name = 'ปิดปรับปรุง';
                                    }
                                } else if (floorIndex === 1 && roomIndex === 0) {
                                    newRoom.type = 'lab'; newRoom.name = labRoomName; newRoom.details = 'LAB คอมพิวเตอร์';
                                } else {
                                    newRoom.type = 'classroom';
                                    if (classroomCursor < classroomPoolCopy.length) newRoom.name = classroomPoolCopy[classroomCursor++];
                                }
                            } else {
                                if (classroomCursor < classroomPoolCopy.length) {
                                    newRoom.type = 'classroom';
                                    newRoom.name = classroomPoolCopy[classroomCursor++];
                                } else {
                                    newRoom.type = 'vacant';
                                }
                            }
                            return newRoom;
                        });
                    });

                    const newData = { grid: newGrid, rowSettings: Array(numRows).fill({ columnWidths: defaultWidths }) };
                    localStorage.setItem(`building_${newBuildingId}`, JSON.stringify(newData));
                }
                
                localStorage.setItem('buildingsList', JSON.stringify(defaultList));
                buildingsList = defaultList;
            } else {
                 buildingsList = JSON.parse(data);
            }

            if (selectedBuildingIndex >= buildingsList.length) {
                selectedBuildingIndex = Math.max(0, buildingsList.length - 1);
                localStorage.setItem('selectedBuildingIndex', selectedBuildingIndex);
            }
            
            updateGlobalAssignedClassrooms();
            renderBuildingSelector();
            renderAll();

            if (buildingsList.length > 0) {
                const selectedBuildingId = buildingsList[selectedBuildingIndex].id;
                loadBuildingData(selectedBuildingId);
            } else {
                showLoader(false);
                dom.buildingContent.classList.add('hidden');
                dom.buildingTitle.textContent = "ไม่มีตึก";
                dom.roomGridContainer.innerHTML = '<p class="p-4 text-center">กรุณาเพิ่มตึก</p>';
            }
        }

        function loadBuildingData(buildingId) {
            if (!buildingId) {
                showLoader(false);
                dom.buildingContent.classList.add('hidden');
                dom.buildingTitle.textContent = "ไม่มีตึก";
                dom.roomGridContainer.innerHTML = '<p class="p-4 text-center">กรุณาเพิ่มตึก</p>';
                return;
            }
            
            showLoader(true);
            
            const buildingName = buildingsList[selectedBuildingIndex]?.name || '';
            dom.buildingTitle.textContent = buildingName;
            
            const buildingData = getBuildingData(buildingId) || { grid: [], rowSettings: [] };

            let rowSettings = buildingData.rowSettings || [];

            if (buildingData.grid.length > 0 && rowSettings.length !== buildingData.grid.length) {
                const numCols = buildingData.grid[0].length;
                const defaultWidths = Array(numCols).fill(100 / numCols);
                rowSettings = buildingData.grid.map(() => ({ columnWidths: defaultWidths }));
            }

            currentBuildingData = { grid: buildingData.grid, rowSettings: rowSettings };
            
            initializeHistory(currentBuildingData);
            
            renderAll();

            if (shouldPreserveScroll) {
                requestAnimationFrame(() => {
                    window.scrollTo({ top: lastScrollY, behavior: 'instant' });
                    shouldPreserveScroll = false; 
                });
            } else if (shouldScrollToTop) {
                requestAnimationFrame(() => {
                    dom.registerRoomCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    shouldScrollToTop = false;
                });
            }

            showLoader(false);
        }
        function saveData(newData) {
            if (buildingsList.length === 0) return;
            const buildingId = buildingsList[selectedBuildingIndex].id;
            localStorage.setItem(`building_${buildingId}`, JSON.stringify(newData));
        }

        function saveClassroomData(dataToSave) {
             localStorage.setItem('classroomData', JSON.stringify(dataToSave));
        }

        function handleSave(e) {
            e.preventDefault();
            const { floor, room } = selectedRoom;
            let updatedData = JSON.parse(JSON.stringify(currentBuildingData));
            const roomToUpdate = updatedData.grid[floor][room];
            
            const isSelectVisible = selectedRoomTypeInModal === 'classroom' || selectedRoomTypeInModal === 'lab';
            const newRoomName = isSelectVisible ? dom.roomNameSelect.value : dom.roomNameInput.value.trim();

            roomToUpdate.type = selectedRoomTypeInModal;
            roomToUpdate.name = newRoomName;
            roomToUpdate.id = dom.roomId.value.trim();
            roomToUpdate.details = dom.roomDetails.value.trim();
            
            pushToHistory(updatedData);
            currentBuildingData = updatedData;
            
            lastScrollY = window.scrollY;
            shouldPreserveScroll = true;

            saveData(updatedData);
            updateGlobalAssignedClassrooms(); 
            renderAll();
            closeModal();
        }

        // --- BUILDING MANAGEMENT ---
        function openBuildingModal(mode, index = -1) {
            buildingModalState = { visible: true, mode, index };
            dom.buildingModalTitle.textContent = mode === 'add' ? 'เพิ่มตึกใหม่' : 'เปลี่ยนชื่อตึก';
            dom.buildingNameInput.value = mode === 'rename' ? buildingsList[index].name : '';
            dom.buildingModal.classList.remove('hidden');
            dom.buildingModal.classList.add('flex');
            dom.buildingNameInput.focus();
        }

        function closeBuildingModal() {
            buildingModalState = { visible: false, mode: 'add', index: -1 };
            dom.buildingModal.classList.add('hidden');
            dom.buildingModal.classList.remove('flex');
        }

        function handleBuildingFormSubmit(e) {
            e.preventDefault();
            const newName = dom.buildingNameInput.value.trim();
            if (!newName) return;
            const { mode, index } = buildingModalState;
            if (mode === 'add') addBuilding(newName);
            else renameBuilding(index, newName);
            closeBuildingModal();
        }

        function addBuilding(name) {
            shouldScrollToTop = true;
            const newBuildingId = 'bldg_' + Date.now();
            
            let currentList = JSON.parse(localStorage.getItem('buildingsList') || '[]');
            currentList.push({ id: newBuildingId, name });
            localStorage.setItem('buildingsList', JSON.stringify(currentList));
            
            const numCols = 15, numRows = 6;
            const defaultWidths = Array(numCols).fill(100/numCols);
            const newGrid = Array.from({ length: numRows }, () => {
                return Array.from({ length: numCols }, () => createNewRoom());
            });
            const newData = { grid: newGrid, rowSettings: Array(numRows).fill({ columnWidths: defaultWidths }) };
            localStorage.setItem(`building_${newBuildingId}`, JSON.stringify(newData));
            
            selectedBuildingIndex = currentList.length - 1;
            localStorage.setItem('selectedBuildingIndex', selectedBuildingIndex);
            
            // Reload the list to reflect changes
            loadBuildingsList();
        }

        function renameBuilding(index, newName) {
            let currentList = JSON.parse(localStorage.getItem('buildingsList') || '[]');
            currentList[index].name = newName;
            localStorage.setItem('buildingsList', JSON.stringify(currentList));
            loadBuildingsList(); // Refresh UI
        }

        function handleDeleteBuilding(index) {
            const buildingName = buildingsList[index].name;
            showConfirmation(`คุณแน่ใจหรือไม่ว่าต้องการลบ '${buildingName}'? การกระทำนี้ไม่สามารถย้อนกลับได้`, () => {
                let currentList = JSON.parse(localStorage.getItem('buildingsList') || '[]');
                const buildingIdToDelete = currentList[index].id;
                
                currentList.splice(index, 1);
                localStorage.setItem('buildingsList', JSON.stringify(currentList));
                localStorage.removeItem(`building_${buildingIdToDelete}`);
                
                // Adjust selected index if needed
                if (selectedBuildingIndex >= currentList.length) {
                    selectedBuildingIndex = Math.max(0, currentList.length - 1);
                     localStorage.setItem('selectedBuildingIndex', selectedBuildingIndex);
                }
                
                loadBuildingsList(); // Reload and re-render everything
            });
        }

        // --- MERGE LOGIC ---
        function toggleMergeMode() {
            isMergeMode = !isMergeMode; 
            selectedForMerge = [];
            
            dom.normalModeControls.classList.toggle('hidden', isMergeMode);
            dom.mergeActions.classList.toggle('hidden', !isMergeMode);

            renderRoomGrid();
        }
        function handleCellSelectForMerge(floor, room) {
            if (currentBuildingData.grid[floor][room].mergeInfo) return showToast('ห้องนี้ถูกรวมไปแล้ว');
            if (selectedForMerge.length > 0 && selectedForMerge[0].floor !== floor) return showToast('กรุณาเลือกห้องในชั้นเดียวกัน');
            const index = selectedForMerge.findIndex(s => s.floor === floor && s.room === room);
            if (index > -1) selectedForMerge.splice(index, 1);
            else selectedForMerge.push({ floor, room });
            renderRoomGrid();
        }
        function handleConfirmMerge() {
            if (selectedForMerge.length < 2) return showToast('กรุณาเลือกอย่างน้อย 2 ห้อง');
            selectedForMerge.sort((a, b) => a.room - b.room);
            for (let i = 1; i < selectedForMerge.length; i++) if (selectedForMerge[i].room !== selectedForMerge[i-1].room + 1) return showToast('ต้องเลือกห้องที่อยู่ติดกัน');
            
            let updatedData = JSON.parse(JSON.stringify(currentBuildingData));
            const primaryCellCoords = selectedForMerge[0]; const span = selectedForMerge.length;
            selectedForMerge.forEach(sel => {
                const isPrimary = sel.floor === primaryCellCoords.floor && sel.room === primaryCellCoords.room;
                updatedData.grid[sel.floor][sel.room].mergeInfo = { isMerged: true, isPrimary, primaryCell: primaryCellCoords, span: isPrimary ? span : 0 };
            });
            
            pushToHistory(updatedData);
            currentBuildingData = updatedData;
            
            lastScrollY = window.scrollY;
            shouldPreserveScroll = true;

            saveData(updatedData);
            updateGlobalAssignedClassrooms();
            renderAll();
            toggleMergeMode();
        }
        function handleUnmerge() {
            showConfirmation('คุณแน่ใจหรือไม่ว่าต้องการแยกห้อง?', () => {
                const { floor, room } = selectedRoom;
                const primaryCoords = currentBuildingData.grid[floor][room].mergeInfo.primaryCell;
                let updatedData = JSON.parse(JSON.stringify(currentBuildingData));
                updatedData.grid[primaryCoords.floor].forEach(cell => {
                    if (cell.mergeInfo && cell.mergeInfo.primaryCell.room === primaryCoords.room) cell.mergeInfo = null;
                });
                
                pushToHistory(updatedData);
                currentBuildingData = updatedData;
                
                lastScrollY = window.scrollY;
                shouldPreserveScroll = true;

                saveData(updatedData);
                updateGlobalAssignedClassrooms();
                renderAll();
                closeModal();
            });
        }

        // --- RESIZE LOGIC ---
        function handleDragStart(e, floorIndex, resizerIndex) {
            e.preventDefault();
            dragState = {
                isDragging: true,
                floorIndex: floorIndex,
                resizerIndex: resizerIndex,
                startX: e.clientX,
                initialWidths: {
                    left: currentBuildingData.rowSettings[floorIndex].columnWidths[resizerIndex],
                    right: currentBuildingData.rowSettings[floorIndex].columnWidths[resizerIndex + 1]
                },
                rowElement: e.target.closest('.relative').querySelector('.grid'),
                resizerElement: e.target,
                tempData: JSON.parse(JSON.stringify(currentBuildingData))
            };
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);
        }

        function handleDragMove(e) {
            if (!dragState.isDragging) return;
            const gridRect = dragState.rowElement.getBoundingClientRect();
            const deltaX = e.clientX - dragState.startX;
            const deltaPercent = (deltaX / gridRect.width) * 100;
            const { floorIndex, resizerIndex, initialWidths } = dragState;

            let newLeftWidth = initialWidths.left + deltaPercent;
            
            const SNAP_THRESHOLD = 1.0; 
            let hasSnapped = false;
            const cumulativeWidthBefore = dragState.tempData.rowSettings[floorIndex].columnWidths.slice(0, resizerIndex).reduce((acc, w) => acc + w, 0);
            const idealDividerPos = cumulativeWidthBefore + newLeftWidth;

            const checkAndSnap = (adjacentFloorIndex) => {
                if (hasSnapped || !dragState.tempData.rowSettings[adjacentFloorIndex]) return;
                const adjacentRowSettings = dragState.tempData.rowSettings[adjacentFloorIndex];
                const targetDividerPos = adjacentRowSettings.columnWidths.slice(0, resizerIndex + 1).reduce((acc, w) => acc + w, 0);
                if (Math.abs(idealDividerPos - targetDividerPos) < SNAP_THRESHOLD) {
                    newLeftWidth = targetDividerPos - cumulativeWidthBefore; hasSnapped = true;
                }
            };
            checkAndSnap(floorIndex - 1); checkAndSnap(floorIndex + 1);

            if (dragState.resizerElement) dragState.resizerElement.style.backgroundColor = hasSnapped ? 'rgba(22, 163, 74, 0.5)' : '';
            
            let newRightWidth = initialWidths.left + initialWidths.right - newLeftWidth;

            const minWidth = 5; 
            if (newLeftWidth < minWidth) { newLeftWidth = minWidth; newRightWidth = initialWidths.left + initialWidths.right - minWidth; }
            if (newRightWidth < minWidth) { newRightWidth = minWidth; newLeftWidth = initialWidths.left + initialWidths.right - minWidth; }

            const currentRowSettings = dragState.tempData.rowSettings[floorIndex];
            currentRowSettings.columnWidths[resizerIndex] = newLeftWidth;
            currentRowSettings.columnWidths[resizerIndex + 1] = newRightWidth;
            
            dragState.rowElement.style.gridTemplateColumns = currentRowSettings.columnWidths.map(w => `${w}%`).join(' ');
            let cumulativeWidth = 0;
            for(let i=0; i < currentRowSettings.columnWidths.length -1; i++) {
                cumulativeWidth += currentRowSettings.columnWidths[i];
                if(dragState.resizerElement.parentElement.children[i]) {
                    dragState.resizerElement.parentElement.children[i].style.left = `${cumulativeWidth}%`;
                }
            }
        }

        function handleDragEnd() {
            if (!dragState.isDragging) return;
            if (dragState.resizerElement) dragState.resizerElement.style.backgroundColor = '';
            
            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', handleDragEnd);

            lastScrollY = window.scrollY;
            shouldPreserveScroll = true;

            pushToHistory(dragState.tempData);
            currentBuildingData = dragState.tempData;
            saveData(currentBuildingData);
            dragState = { isDragging: false };
            renderRoomGrid();
        }

        // --- GRID & ROOM ACTIONS ---
        function performGridAction(action) {
            let updatedData = JSON.parse(JSON.stringify(currentBuildingData));
            action(updatedData);
            pushToHistory(updatedData);
            currentBuildingData = updatedData;
            saveData(updatedData);
            updateGlobalAssignedClassrooms();
            renderAll();
        }

        const addRow = () => {
            lastScrollY = window.scrollY;
            shouldPreserveScroll = true;
            performGridAction(d => {
                const numCols = d.grid[0]?.length || 15;
                d.grid.push(Array.from({ length: numCols }, createNewRoom)); 
                d.rowSettings.push({ columnWidths: Array(numCols).fill(100 / numCols) });
            });
        };
        const deleteRow = () => showConfirmation('คุณแน่ใจหรือไม่ว่าต้องการลบชั้นบนสุด?', () => {
            lastScrollY = window.scrollY;
            shouldPreserveScroll = true;
            performGridAction(d => {
                if (d.grid.length > 1) { d.grid.pop(); d.rowSettings.pop(); }
            });
        });
        const addColumn = () => {
            lastScrollY = window.scrollY;
            shouldPreserveScroll = true;
            performGridAction(d => {
                if (d.grid.length > 0) {
                    d.grid.forEach(f => f.push(createNewRoom()));
                    const newNumCols = d.grid[0].length;
                    d.rowSettings.forEach(rs => { rs.columnWidths = Array(newNumCols).fill(100 / newNumCols) });
                }
            });
        };
        const deleteColumn = () => showConfirmation('คุณแน่ใจหรือไม่ว่าต้องการลบห้องสุดท้ายของทุกชั้น?', () => {
            lastScrollY = window.scrollY;
            shouldPreserveScroll = true;
            performGridAction(d => {
                if (d.grid[0]?.length > 1) {
                    d.grid.forEach(f => f.pop());
                    const newNumCols = d.grid[0].length;
                     d.rowSettings.forEach(rs => { rs.columnWidths = Array(newNumCols).fill(100 / newNumCols) });
                }
            });
        });
        const handleDeleteData = () => showConfirmation('คุณแน่ใจหรือไม่ว่าจะล้างข้อมูลห้องนี้?', () => { 
            lastScrollY = window.scrollY;
            shouldPreserveScroll = true;
            performGridAction(d => { 
                const {floor, room} = selectedRoom;
                const originalMergeInfo = d.grid[floor][room].mergeInfo;
                d.grid[floor][room] = createNewRoom(); 
                d.grid[floor][room].mergeInfo = originalMergeInfo;
            });
            closeModal(); 
        });

        function handleResetBuilding() {
            showConfirmation('ทุกห้องในตึกนี้จะถูกตั้งเป็น "ห้องว่าง" ', () => {
                lastScrollY = window.scrollY;
                shouldPreserveScroll = true;

                let updatedData = JSON.parse(JSON.stringify(currentBuildingData));
                const numRows = updatedData.grid.length;
                const numCols = updatedData.grid[0]?.length || 15;
                
                updatedData.grid = Array.from({ length: numRows }, () => 
                    Array.from({ length: numCols }, createNewRoom)
                );
                
                const newWidths = Array(numCols).fill(100 / numCols);
                updatedData.rowSettings = updatedData.rowSettings.map(rs => ({ ...rs, columnWidths: newWidths }));

                pushToHistory(updatedData);
                currentBuildingData = updatedData;
                saveData(updatedData);
                updateGlobalAssignedClassrooms();
                renderAll();
            });
        }
        
        // --- NEW CLASSROOM NAMES MANAGEMENT ---
        function promptForRoomName(row, col) {
            const category = tempClassroomData.categories[selectedClassroomCategoryIndex];
            if (!category) return;
            const gridData = tempClassroomData.grids[category.id];
            if (!gridData || !gridData.grid) return;
            
            const room = gridData.grid[row][col];
            const currentName = room.name || '';
            const newName = prompt(`แก้ไขชื่อห้อง:`, currentName);

            if (newName !== null && newName.trim() !== '') {
                room.name = newName.trim();
                renderClassroomGrid();
            }
        }

        function renderClassroomGrid() {
            const container = dom.classroomGridContainer;
            container.innerHTML = '';
            
            if (!tempClassroomData || !tempClassroomData.categories[selectedClassroomCategoryIndex]) return;

            const category = tempClassroomData.categories[selectedClassroomCategoryIndex];
            const gridData = tempClassroomData.grids[category.id];

            if (!gridData || !gridData.grid || gridData.grid.length === 0) {
                 container.innerHTML = `<div class="text-center text-gray-500 col-span-full p-4">ไม่มีห้องในหมวดหมู่นี้</div>`;
                return;
            }

            const grid = gridData.grid;
            const numCols = grid[0]?.length || 1;
            
            container.style.gridTemplateColumns = `repeat(${numCols}, auto)`;
            
            grid.flat().forEach((room, index) => {
                const row = Math.floor(index / numCols);
                const col = index % numCols;

                const cell = document.createElement('div');
                cell.className = `relative group p-2 rounded text-xs truncate border cursor-pointer ${room.hidden ? 'border-gray-300 text-gray-400 font-normal hover:bg-gray-200' : 'border-black text-black font-bold bg-white hover:bg-gray-100'}`;
                cell.onclick = () => {
                    const clickedRoom = tempClassroomData.grids[category.id].grid[row][col];
                    clickedRoom.hidden = !clickedRoom.hidden;
                    renderClassroomGrid();
                };
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = room.name || '-';
                nameSpan.title = room.name || 'Empty';
                
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'absolute top-0.5 right-0.5 p-0.5 rounded-full bg-white/50 hover:bg-white opacity-0 group-hover:opacity-100 transition-opacity';
                editBtn.innerHTML = `<svg class="w-3 h-3 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>`;
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    promptForRoomName(row, col);
                };

                cell.appendChild(nameSpan);
                cell.appendChild(editBtn);
                container.appendChild(cell);
            });
        }

        function openClassroomNamesModal() {
            tempClassroomData = JSON.parse(JSON.stringify(classroomData));
            if (selectedClassroomCategoryIndex >= tempClassroomData.categories.length) {
                selectedClassroomCategoryIndex = 0;
            }
            renderClassroomCategoryButtons();
            renderClassroomGrid();
            dom.classroomNamesModal.classList.remove('hidden');
            dom.classroomNamesModal.classList.add('flex');
        }

        function closeClassroomNamesModal() {
            dom.classroomNamesModal.classList.add('hidden');
            dom.classroomNamesModal.classList.remove('flex');
        }
        
        function invalidateHiddenClassroomsAcrossAllBuildings() {
            const visibleNames = getVisibleClassroomNames();
            const visibleNamesSet = new Set(visibleNames);

            buildingsList.forEach(building => {
                const buildingData = getBuildingData(building.id);
                if (!buildingData || !buildingData.grid) return;

                let needsUpdate = false;
                buildingData.grid.forEach(floor => {
                    floor.forEach(room => {
                        if ((room.type === 'classroom' || room.type === 'lab') && !visibleNamesSet.has(room.name)) {
                             Object.assign(room, createNewRoom());
                             needsUpdate = true;
                        }
                    });
                });

                if (needsUpdate) {
                    localStorage.setItem(`building_${building.id}`, JSON.stringify(buildingData));
                }
            });
        }

        function handleClassroomSave() {
            classroomData = JSON.parse(JSON.stringify(tempClassroomData));
            saveClassroomData(classroomData);
            
            invalidateHiddenClassroomsAcrossAllBuildings();
            
            updateGlobalAssignedClassrooms();
            renderAll();
            
            closeClassroomNamesModal();
            showToast('บันทึกข้อมูลห้องเรียนสำเร็จ', false);
        }

        function renderClassroomCategoryButtons() {
            const container = dom.classroomCategoryButtons;
            container.innerHTML = '';
            tempClassroomData.categories.forEach((cat, index) => {
                const buttonWrapper = document.createElement('div');
                buttonWrapper.className = 'relative group';

                const button = document.createElement('button');
                button.className = `px-3 py-1.5 text-sm rounded-full transition-colors border pr-8 ${index === selectedClassroomCategoryIndex ? 'bg-black text-white border-black font-semibold' : 'bg-transparent text-gray-500 border-gray-400 hover:bg-gray-100 font-normal'}`;
                button.textContent = cat.name;
                button.onclick = () => {
                    selectedClassroomCategoryIndex = index;
                    renderClassroomCategoryButtons();
                    renderClassroomGrid();
                };
                
                const controls = document.createElement('div');
                controls.className = 'absolute top-1/2 right-1 -translate-y-1/2 flex items-center gap-0 opacity-0 group-hover:opacity-100 transition-opacity';
                
                const editBtn = document.createElement('button');
                editBtn.title = "เปลี่ยนชื่อ";
                editBtn.className = 'p-0.5 rounded-full hover:bg-gray-200';
                editBtn.innerHTML = `<svg class="w-3 h-3 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>`;
                editBtn.onclick = (e) => { e.stopPropagation(); openCategoryNameModal('edit', index); };

                const deleteBtn = document.createElement('button');
                deleteBtn.title = "ลบ";
                deleteBtn.className = 'p-0.5 rounded-full hover:bg-gray-200';
                deleteBtn.innerHTML = `<svg class="w-3 h-3 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>`;
                deleteBtn.onclick = (e) => { e.stopPropagation(); handleDeleteClassroomCategory(index); };
                
                controls.appendChild(editBtn);
                controls.appendChild(deleteBtn);
                buttonWrapper.appendChild(button);
                buttonWrapper.appendChild(controls);
                container.appendChild(buttonWrapper);
            });
        }
        
        function openCategoryNameModal(mode, index = -1) {
            categoryModalState = { visible: true, mode, index };
            dom.categoryNameModalTitle.textContent = mode === 'add' ? 'เพิ่มหมวดหมู่ใหม่' : 'เปลี่ยนชื่อหมวดหมู่';
            dom.categoryNameInput.value = mode === 'edit' ? tempClassroomData.categories[index].name : '';
            dom.categoryNameModal.classList.remove('hidden');
            dom.categoryNameModal.classList.add('flex');
            dom.categoryNameInput.focus();
        }
        
        function closeCategoryNameModal() {
            categoryModalState = { visible: false, mode: 'add', index: -1 };
            dom.categoryNameModal.classList.add('hidden');
            dom.categoryNameModal.classList.remove('flex');
        }

        function handleCategoryNameSubmit(e) {
            e.preventDefault();
            const newName = dom.categoryNameInput.value.trim();
            if (!newName) return;
            const { mode, index } = categoryModalState;

            if (mode === 'add') {
                const newId = `cat_${Date.now()}`;
                tempClassroomData.categories.push({ id: newId, name: newName });
                tempClassroomData.grids[newId] = { grid: [ [{name: 'New 1/1', hidden: false}] ] };
                selectedClassroomCategoryIndex = tempClassroomData.categories.length - 1;
            } else {
                tempClassroomData.categories[index].name = newName;
            }
            
            renderClassroomCategoryButtons();
            renderClassroomGrid();
            closeCategoryNameModal();
        }
        
        function handleDeleteClassroomCategory(index) {
             showConfirmation(`คุณแน่ใจหรือไม่ว่าต้องการลบหมวดหมู่ '${tempClassroomData.categories[index].name}'?`, () => {
                const catIdToDelete = tempClassroomData.categories[index].id;
                tempClassroomData.categories.splice(index, 1);
                delete tempClassroomData.grids[catIdToDelete];
                
                if (selectedClassroomCategoryIndex >= index) {
                    selectedClassroomCategoryIndex = Math.max(0, selectedClassroomCategoryIndex - 1);
                }
                
                renderClassroomCategoryButtons();
                renderClassroomGrid();
            });
        }
        
        function handleClassroomGridAction(action) {
            const category = tempClassroomData.categories[selectedClassroomCategoryIndex];
            if (!category) return;
            const gridData = tempClassroomData.grids[category.id];
            if (!gridData) return;
            if (!gridData.grid) gridData.grid = [];


            action(gridData.grid);
            renderClassroomGrid();
        }

        const addClassroomRow = () => handleClassroomGridAction(grid => {
            const numCols = grid[0]?.length || 1;
            const newRow = Array.from({length: numCols}, (_, i) => ({name: `New ${i+1}/${grid.length + 1}`, hidden: false}));
            grid.push(newRow);
        });

        const deleteClassroomRow = () => handleClassroomGridAction(grid => {
            if (grid.length > 1) grid.pop();
        });

        const addClassroomColumn = () => handleClassroomGridAction(grid => {
            if (grid.length === 0) {
                 grid.push([{name: `New 1/1`, hidden: false}]);
                 return;
            }
            const numCols = grid[0].length;
            grid.forEach((row, i) => row.push({name: `New ${numCols + 1}/${i + 1}`, hidden: false}));
        });
        
        const deleteClassroomColumn = () => handleClassroomGridAction(grid => {
            if (grid[0]?.length > 1) grid.forEach(row => row.pop());
        });

        function handleShowAllRooms() {
            const category = tempClassroomData.categories[selectedClassroomCategoryIndex];
            if (!category) return;
            const gridData = tempClassroomData.grids[category.id];
            if (!gridData || !gridData.grid) return;
            gridData.grid.flat().forEach(room => room.hidden = false);
            renderClassroomGrid();
        }

        function handleHideAllRooms() {
             const category = tempClassroomData.categories[selectedClassroomCategoryIndex];
            if (!category) return;
            const gridData = tempClassroomData.grids[category.id];
            if (!gridData || !gridData.grid) return;
            gridData.grid.flat().forEach(room => room.hidden = true);
            renderClassroomGrid();
        }
        
        // --- PRINTING LOGIC (REFACTORED FOR SCALING PREVIEW) ---
        function openPrintModal() {
            dom.printModal.classList.remove('hidden');
            dom.printModal.classList.add('flex');
            renderPrintOrientationSelector();
            renderPrintContentSelectors();
            generatePrintPreview();
        }

        function closePrintModal() {
            dom.printModal.classList.add('hidden');
            dom.printModal.classList.remove('flex');
            // Disconnect observer to prevent memory leaks when modal is closed
            if (previewResizeObserver) {
                previewResizeObserver.disconnect();
                previewResizeObserver = null;
            }
        }

        function renderPrintOrientationSelector() {
            const container = dom.printOrientationSelector;
            const options = [
                {
                    value: 'portrait',
                    label: 'แนวตั้ง',
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 -960 960 960" fill="currentColor"><path d="M240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Zm280-520v-200H240v640h480v-440H520ZM240-800v200-200 640-640Z"/></svg>'
                },
                {
                    value: 'landscape',
                    label: 'แนวนอน',
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 -rotate-90" viewBox="0 -960 960 960" fill="currentColor"><path d="M240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Zm280-520v-200H240v640h480v-440H520ZM240-800v200-200 640-640Z"/></svg>'
                },
            ];

            let buttonsHtml = '';
            options.forEach((opt, index) => {
                const isSelected = printOrientation === opt.value;
                const separatorClass = index === 0 ? 'border-r border-black' : '';
                buttonsHtml += `
                    <button data-orientation="${opt.value}" class="w-1/2 text-sm py-2 px-3 transition-colors flex items-center justify-center gap-2 ${separatorClass} ${ isSelected ? 'bg-black text-white' : 'bg-transparent text-black hover:bg-gray-100' }">
                        ${opt.icon}
                        <span>${opt.label}</span>
                    </button>
                `;
            });
            
            container.className = 'flex border border-black rounded-md overflow-hidden';
            container.innerHTML = buttonsHtml;
        }
        
        function renderPrintContentSelectors() {
            const container = dom.printContentSelectors;
            const contentTypes = [
                { key: 'layout', label: 'สรุป ผังตึก / ห้องเรียน' },
                { key: 'studentSummary', label: 'สรุปห้องนักเรียน' },
                { key: 'buildingSummary', label: 'สรุปอาคาร' }
            ];
 
            container.innerHTML = contentTypes.map(type => {
                const isSelected = selectedPrintPreviewType === type.key;
                const selectedClasses = 'border-black';
                const unselectedClasses = 'border-gray-300 hover:border-gray-400';
                const selectedTextClasses = 'text-black font-semibold';
                const unselectedTextClasses = 'text-gray-600';
                const inputNumberClasses = isSelected ? 'text-black font-semibold' : 'text-gray-500 font-normal';


                return `
                <div data-type="${type.key}" class="flex items-center gap-2">
                    <!-- Composite Input Group -->
                    <div class="flex-grow flex items-center bg-gray-100 rounded-md border overflow-hidden transition-colors cursor-pointer ${isSelected ? selectedClasses : unselectedClasses}">
                        <span class="flex-grow px-3 py-2 text-sm pointer-events-none border-r border-gray-300 ${isSelected ? selectedTextClasses : unselectedTextClasses}">
                            ${type.label}
                        </span>
                        <input type="number" data-type="${type.key}" class="w-16 bg-transparent border-none text-center focus:ring-0 ${inputNumberClasses}" value="${printQuantities[type.key]}" min="1">
                    </div>
                    <!-- Print Button -->
                    <button data-type="${type.key}" title="พิมพ์เฉพาะส่วนนี้" class="print-single-btn flex-shrink-0 w-10 h-10 flex items-center justify-center bg-black hover:bg-gray-800 text-white rounded-md transition-colors">
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" class="w-5 h-5" fill="#FFFFFF"><path d="M640-640v-120H320v120h-80v-200h480v200h-80Zm-480 80h640-640Zm560 100q17 0 28.5-11.5T760-500q0-17-11.5-28.5T720-540q-17 0-28.5 11.5T680-500q0 17 11.5 28.5T720-460Zm-80 260v-160H320v160h320Zm80 80H240v-160H80v-240q0-51 35-85.5t85-34.5h560q51 0 85.5 34.5T880-520v240H720v160Zm80-240v-160q0-17-11.5-28.5T760-560H200q-17 0-28.5 11.5T160-520v160h80v-80h480v80h80Z"/></svg>
                    </button>
                </div>
                `;
            }).join('');
        }
        
        function generateBuildingLayoutForPrint(building) {
            const buildingData = getBuildingData(building.id);
            if (!buildingData || !buildingData.grid || buildingData.grid.length === 0) {
                return `<div class="border border-gray-300 p-4 rounded-lg flex items-center justify-center text-gray-500">ไม่มีข้อมูลสำหรับตึก ${building.name}</div>`;
            }

            const reversedGrid = [...buildingData.grid].reverse();
            const numRows = reversedGrid.length;

            // --- Build Labels Column (FL) ---
            let labelsHtml = '';
            reversedGrid.forEach((_, reversedFloorIndex) => {
                const floorIndex = buildingData.grid.length - 1 - reversedFloorIndex;
                labelsHtml += `<div class="flex items-center justify-center text-gray-700 font-normal text-sm px-4">ชั้น ${floorIndex + 1}</div>`;
            });
            const labelsColumnHtml = `<div class="grid" style="grid-template-rows: repeat(${numRows}, 1fr);">${labelsHtml}</div>`;

            // --- Build Rooms Column (RR Table) ---
            let roomsHtml = '';
            reversedGrid.forEach((floor, reversedFloorIndex) => {
                const floorIndex = buildingData.grid.length - 1 - reversedFloorIndex;
                const rowSettings = buildingData.rowSettings[floorIndex];
                if (!rowSettings) return;

                const borderClass = reversedFloorIndex > 0 ? 'border-t border-gray-800' : '';
                
                let roomsInRowHtml = '';
                for (let roomIndex = 0; roomIndex < floor.length; roomIndex++) {
                    const room = floor[roomIndex];
                    if (room.mergeInfo && room.mergeInfo.isMerged && !room.mergeInfo.isPrimary) continue;

                    let cellClasses = 'py-1 px-2 flex flex-col justify-center text-center';
                    
                    if (room.type === 'office') cellClasses += ' bg-gray-400';
                    else if (room.type === 'renovation') cellClasses += ' bg-red-600 text-white items-center';
                    else if (room.type === 'lab') {
                        cellClasses += ' bg-yellow-200';
                        if (room.name === 'ว่าง') cellClasses += ' border border-dashed border-gray-400';
                    }
                    else if (room.type === 'vacant') cellClasses += ' bg-slate-200 border border-dashed border-gray-400';
                    else cellClasses += ' bg-gray-50';

                    const gridColumn = (room.mergeInfo && room.mergeInfo.isPrimary) ? `style="grid-column: span ${room.mergeInfo.span}"` : '';
                    
                    const buildingStr = (buildingsList.findIndex(b => b.id === building.id) + 1).toString();
                    const floorStr = (floorIndex + 1).toString();
                    const roomStr = (roomIndex + 1).toString();
                    const defaultRoomId = `${buildingStr} ${floorStr} ${roomStr}`;
                    
                    let cellContentHtml = '';
                    if (room.type === 'renovation') {
                        cellContentHtml = `<div class="font-bold text-sm truncate leading-tight" title="${room.id || defaultRoomId}">${room.id || defaultRoomId}</div><div class="font-semibold text-xs truncate leading-tight">ปิดปรับปรุง</div><div class="text-[11px] text-gray-200 truncate leading-tight">- - -</div>`;
                    } else {
                        cellContentHtml = `<div class="font-bold text-sm truncate leading-tight" title="${room.id || defaultRoomId}">${room.id || defaultRoomId}</div><div class="font-semibold text-xs truncate leading-tight" title="${room.name || 'N/A'}">${room.name || 'N/A'}</div><div class="text-[11px] text-gray-500 truncate leading-tight" title="${room.details || ''}">${room.details || ''}</div>`;
                    }
                    roomsInRowHtml += `<div class="${cellClasses}" ${gridColumn}>${cellContentHtml}</div>`;
                }

                const rowGridHtml = `<div class="grid divide-x divide-gray-800" style="grid-template-columns: ${rowSettings.columnWidths.map(w => `${w}%`).join(' ')}">${roomsInRowHtml}</div>`;
                roomsHtml += `<div class="relative ${borderClass}">${rowGridHtml}</div>`;
            });
            const roomsColumnHtml = `<div class="border border-gray-800 rounded-lg overflow-hidden flex flex-col">${roomsHtml}</div>`;

            const gridContainerHtml = `<div class="grid" style="grid-template-columns: auto 1fr; column-gap: 1rem;">${labelsColumnHtml}${roomsColumnHtml}</div>`;
            
            const finalHtml = `<div class="border border-gray-400 p-3 rounded-lg bg-white flex flex-col text-[10px]"><h2 class="text-base font-bold text-center mb-2 flex-shrink-0">${building.name}</h2>${gridContainerHtml}</div>`;

            return finalHtml;
        }

        function generateStudentSummaryCategoryBlocks() {
            const classroomsToDisplay = getVisibleClassroomNames();
            if (classroomsToDisplay.length === 0) return [];

            const studentRoomsData = {};
            const allBuildingsData = buildingsList.map(building => getBuildingData(building.id));

            allBuildingsData.forEach((buildingData, buildingIndex) => {
                 if (buildingData && buildingData.grid) {
                    buildingData.grid.forEach((floor, floorIndex) => {
                        floor.forEach((room, roomIndex) => {
                            if ((room.type === 'classroom' || room.type === 'lab') && classroomsToDisplay.includes(room.name)) {
                               studentRoomsData[room.name] = { ...room, _buildingIndex: buildingIndex, _floorIndex: floorIndex, _roomIndex: roomIndex };
                            }
                        });
                    });
                }
            });

            const groupedClassrooms = classroomsToDisplay.reduce((acc, name) => {
                const prefixMatch = name.match(/^([^\d]+)(\d*)/);
                const prefix = prefixMatch ? (prefixMatch[1].trim() + (prefixMatch[2] ? ` ${prefixMatch[2]}` : '')).trim() : 'อื่น ๆ';
                if (!acc[prefix]) acc[prefix] = [];
                acc[prefix].push(name);
                return acc;
            }, {});

            const categoryOrder = ['อนุบาล', 'ประถม', 'มัธยม'];
            const sortedGroupNames = Object.keys(groupedClassrooms).sort((a, b) => {
                const aIndex = categoryOrder.findIndex(cat => a.startsWith(cat));
                const bIndex = categoryOrder.findIndex(cat => b.startsWith(cat));
                if (aIndex !== -1 && bIndex !== -1 && aIndex !== bIndex) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;
                return naturalSort(a, b);
            });

            const categoryBlocks = [];
            for (const groupName of sortedGroupNames) {
                let blockHtml = `<div class="border border-gray-300 rounded-md overflow-hidden h-full flex flex-col text-[9px] break-inside-avoid">`;
                blockHtml += `<div class="font-bold bg-gray-200 px-2 py-1 grid grid-cols-2 gap-2 text-xs"><div>${groupName}</div><div>รหัสห้อง</div></div>`;
                let rowsHtml = '';
                groupedClassrooms[groupName].forEach(className => {
                    const roomData = studentRoomsData[className];
                    const rowBgClass = (roomData && roomData.type === 'lab') ? 'bg-yellow-50' : 'bg-white';
                    const roomId = roomData ? (roomData.id || `${roomData._buildingIndex + 1} ${roomData._floorIndex + 1} ${roomData._roomIndex + 1}`) : '-';
                    const roomIdCellClasses = !roomData ? 'bg-zinc-700 text-white text-center rounded' : 'text-gray-600';
                    rowsHtml += `<div class="grid grid-cols-2 gap-2 px-2 py-0.5 border-b border-gray-200 last:border-b-0 ${rowBgClass}"><div class="font-semibold">${className}</div><div class="${roomIdCellClasses}">${roomId}</div></div>`;
                });
                blockHtml += `<div class="bg-white flex-grow">${rowsHtml}</div></div>`;
                categoryBlocks.push(blockHtml);
            }
            return categoryBlocks;
        }

        function generateStudentSummaryPages() {
            const categoryBlocks = generateStudentSummaryCategoryBlocks();
            if (categoryBlocks.length === 0) {
                return [`<div class="p-4 flex items-center justify-center h-full"><p class="text-gray-500">ไม่มีข้อมูลห้องเรียน</p></div>`];
            }

            const CHUNK_SIZE = 6;
            const chunks = [];
            for (let i = 0; i < categoryBlocks.length; i += CHUNK_SIZE) {
                chunks.push(categoryBlocks.slice(i, i + CHUNK_SIZE));
            }

            const pageContents = [];
            chunks.forEach((chunk, pageIndex) => {
                const gridContent = chunk.join('');
                const pageHtml = `
                    <div class="p-4 bg-white h-full text-[10px] flex flex-col">
                        <h2 class="text-base font-bold text-center mb-4 flex-shrink-0">สรุปห้องนักเรียน ${chunks.length > 1 ? `(หน้า ${pageIndex + 1}/${chunks.length})` : ''}</h2>
                        <div class="flex-grow grid grid-cols-3 gap-4" style="grid-template-rows: repeat(2, 1fr);">
                            ${gridContent}
                        </div>
                    </div>`;
                pageContents.push(pageHtml);
            });
            return pageContents;
        }

        function generateStudentSummaryForPrint() {
            return generateStudentSummaryPages().join('');
        }

        function generateSingleBuildingSummaryForPrint(building, index) {
             const buildingData = getBuildingData(building.id);
             if (!buildingData || !buildingData.grid || buildingData.grid.length === 0) return '';
             
             let tableContent = '';
             buildingData.grid.forEach((floor, floorIndex) => {
                 floor.forEach((room, roomIndex) => {
                    const buildingStr = (index + 1).toString();
                    const floorStr = (floorIndex + 1).toString();
                    const roomStr = (roomIndex + 1).toString();
                    const defaultRoomId = `${buildingStr} ${floorStr} ${roomStr}`;
                    let rowClasses = '';
                    switch (room.type) {
                        case 'lab': rowClasses += ' bg-yellow-50'; break;
                        case 'office': rowClasses += ' bg-slate-100'; break;
                        case 'renovation': rowClasses += ' bg-red-100'; break;
                    }
                    tableContent += `
                        <tr class="${rowClasses}">
                            <td class="border border-gray-300 px-2 py-1 text-center">${floorIndex + 1}</td>
                            <td class="border border-gray-300 px-2 py-1">${room.id || defaultRoomId}</td>
                            <td class="border border-gray-300 px-2 py-1">${room.name || '-'}</td>
                            <td class="border border-gray-300 px-2 py-1">${room.details || '-'}</td>
                        </tr>
                    `;
                 });
             });

             return `<div class="border border-gray-300 rounded-md overflow-hidden h-full flex flex-col text-[10px] break-inside-avoid">
                <h3 class="text-sm font-bold text-center p-2 bg-gray-200 flex-shrink-0">${building.name}</h3>
                <div class="flex-grow overflow-auto">
                    <table class="w-full border-collapse">
                         <thead>
                            <tr>
                                <th class="border border-gray-400 px-2 py-1 bg-gray-100">ชั้น</th>
                                <th class="border border-gray-400 px-2 py-1 bg-gray-100">เลขห้อง</th>
                                <th class="border border-gray-400 px-2 py-1 bg-gray-100">ชื่อห้อง</th>
                                <th class="border border-gray-400 px-2 py-1 bg-gray-100">รายละเอียด</th>
                            </tr>
                         </thead>
                         <tbody>${tableContent}</tbody>
                    </table>
                </div>
             </div>`;
        }

        function generateBuildingSummaryPages() {
            const buildingBlocks = buildingsList.map((building, index) => generateSingleBuildingSummaryForPrint(building, index)).filter(Boolean);
            if (buildingBlocks.length === 0) {
                return [`<div class="p-4 flex items-center justify-center h-full"><p class="text-gray-500">ไม่มีข้อมูลอาคาร</p></div>`];
            }

            const CHUNK_SIZE = 4;
            const chunks = [];
            for (let i = 0; i < buildingBlocks.length; i += CHUNK_SIZE) {
                chunks.push(buildingBlocks.slice(i, i + CHUNK_SIZE));
            }

            const pageContents = [];
            chunks.forEach((chunk, pageIndex) => {
                const gridContent = chunk.join('');
                const pageHtml = `
                    <div class="p-4 bg-white h-full text-[10px] flex flex-col">
                        <h2 class="text-base font-bold text-center mb-4 flex-shrink-0">สรุปอาคาร ${chunks.length > 1 ? `(หน้า ${pageIndex + 1}/${chunks.length})` : ''}</h2>
                        <div class="flex-grow grid grid-cols-2 gap-4" style="grid-template-rows: repeat(2, 1fr);">
                            ${gridContent}
                        </div>
                    </div>`;
                pageContents.push(pageHtml);
            });
            return pageContents;
        }

        function generateBuildingSummaryForPrint() {
            return generateBuildingSummaryPages().join('');
        }

        function generatePrintPreview() {
            const scaler = document.getElementById('print-preview-scaler');
            scaler.innerHTML = '';
            let contentHtml = '';
            
            dom.printPreviewTitle.textContent = `ตัวอย่าง ก่อนพิมพ์ : ${
                {layout: 'ผังตึก', studentSummary: 'สรุปห้องนักเรียน', buildingSummary: 'สรุปอาคาร'}[selectedPrintPreviewType] || 'ทั้งหมด'
            }`;

            const pageClass = `a4-preview-page a4-${printOrientation}`;
            let pageContents = [];

            if (selectedPrintPreviewType === 'layout') {
                pageContents = buildingsList.map(b => `<div class="p-4 flex-grow print-grid-wrapper">${generateBuildingLayoutForPrint(b)}</div>`);
            } else if (selectedPrintPreviewType === 'studentSummary') {
                pageContents = generateStudentSummaryPages();
            } else if (selectedPrintPreviewType === 'buildingSummary') {
                pageContents = generateBuildingSummaryPages();
            }
            
            const pagesHtml = pageContents.map(content => `<div class="${pageClass} print-page">${content}</div>`).join('');
            
            const quantity = printQuantities[selectedPrintPreviewType] || 1;
            for (let i = 0; i < quantity; i++) {
                contentHtml += pagesHtml;
            }

            scaler.innerHTML = contentHtml;
            scalePrintPreview();

            if (!previewResizeObserver) {
                previewResizeObserver = new ResizeObserver(scalePrintPreview);
                previewResizeObserver.observe(dom.printPreviewViewport);
            }
        }

        function scalePrintPreview() {
            const viewport = dom.printPreviewViewport;
            const scaler = document.getElementById('print-preview-scaler');
            const page = scaler.firstChild; 

            if (!page) return;

            const viewportWidth = viewport.clientWidth;
            const viewportHeight = viewport.clientHeight;

            const pageWidth = page.offsetWidth;
            const pageHeight = page.offsetHeight;
            
            if (pageWidth === 0 || pageHeight === 0) return;

            const scale = Math.min(viewportWidth / pageWidth, viewportHeight / pageHeight);
            
            scaler.style.transform = `scale(${scale})`;
        }

        function handlePrint(contentType = 'all') {
            const container = dom.printContainer;
            container.innerHTML = '';

            let pagesHtml = '';

            const pageTypes = contentType === 'all' 
                ? [
                    { type: 'layout', count: printQuantities.layout },
                    { type: 'studentSummary', count: printQuantities.studentSummary },
                    { type: 'buildingSummary', count: printQuantities.buildingSummary }
                  ]
                : [{ type: contentType, count: 1 }];

            pageTypes.forEach(page => {
                 for (let i = 0; i < page.count; i++) {
                    if (page.type === 'layout') {
                         buildingsList.forEach(b => {
                            pagesHtml += `<div class="print-page"><div class="p-4 flex-grow print-grid-wrapper">${generateBuildingLayoutForPrint(b)}</div></div>`;
                        });
                    } else if (page.type === 'studentSummary') {
                        const studentPages = generateStudentSummaryPages();
                        studentPages.forEach(p => pagesHtml += `<div class="print-page">${p}</div>`);
                    } else if (page.type === 'buildingSummary') {
                        const buildingPages = generateBuildingSummaryPages();
                        buildingPages.forEach(p => pagesHtml += `<div class="print-page">${p}</div>`);
                    }
                }
            });
            
            container.innerHTML = pagesHtml;
            
            const style = document.createElement('style');
            style.innerHTML = `@page { size: A4 ${printOrientation}; margin: 1cm; }`;
            document.head.appendChild(style);
            
            window.print();
            
            document.head.removeChild(style);
            container.innerHTML = '';
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            dom.editForm.onsubmit = handleSave;
            dom.cancelButton.onclick = closeModal;
            dom.confirmCancelBtn.onclick = hideConfirmation;
            dom.deleteDataButton.onclick = handleDeleteData;
            dom.addRowBtn.onclick = addRow;
            dom.deleteRowBtn.onclick = deleteRow;
            dom.addColBtn.onclick = addColumn;
            dom.deleteColBtn.onclick = deleteColumn;
            dom.toggleMergeBtn.onclick = toggleMergeMode;
            dom.confirmMergeBtn.onclick = handleConfirmMerge;
            dom.cancelMergeBtn.onclick = toggleMergeMode;
            dom.unmergeBtn.onclick = handleUnmerge;
            dom.undoBtn.onclick = handleUndo;
            dom.redoBtn.onclick = handleRedo;
            dom.buildingForm.onsubmit = handleBuildingFormSubmit;
            dom.buildingCancelBtn.onclick = closeBuildingModal;
            dom.resetBuildingBtn.onclick = handleResetBuilding;
            
            dom.manageClassroomsBtn.onclick = openClassroomNamesModal;
            dom.classroomNamesSaveBtn.onclick = handleClassroomSave;
            dom.classroomNamesCancelBtn.onclick = closeClassroomNamesModal;
            dom.addClassroomCategoryBtn.onclick = () => openCategoryNameModal('add');
            
            dom.categoryNameForm.onsubmit = handleCategoryNameSubmit;
            dom.categoryNameCancelBtn.onclick = closeCategoryNameModal;
            
            dom.addClassroomRowBtn.onclick = addClassroomRow;
            dom.deleteClassroomRowBtn.onclick = deleteClassroomRow;
            dom.addClassroomColBtn.onclick = addClassroomColumn;
            dom.deleteClassroomColBtn.onclick = deleteClassroomColumn;
            
            dom.showAllRoomsBtn.onclick = handleShowAllRooms;
            dom.hideAllRoomsBtn.onclick = handleHideAllRooms;
            
            dom.printFab.onclick = openPrintModal;
            dom.printCancelBtn.onclick = closePrintModal;
            dom.printAllBtn.onclick = () => handlePrint('all');

            dom.roomTypeSelector.addEventListener('click', e => {
                const button = e.target.closest('.room-type-btn');
                if (button) {
                    selectedRoomTypeInModal = button.dataset.type;
                    renderRoomTypeSelector(selectedRoomTypeInModal);
                    const roomData = currentBuildingData.grid[selectedRoom.floor][selectedRoom.room];
                    updateRoomNameUI(selectedRoomTypeInModal, roomData);
                }
            });

            dom.printOrientationSelector.addEventListener('click', e => {
                 const button = e.target.closest('button[data-orientation]');
                 if (button) {
                    printOrientation = button.dataset.orientation;
                    renderPrintOrientationSelector();
                    generatePrintPreview();
                 }
            });

             dom.printContentSelectors.addEventListener('click', e => {
                const inputGroup = e.target.closest('.flex-grow');
                const singlePrintBtn = e.target.closest('.print-single-btn');

                if (inputGroup) {
                    const type = inputGroup.parentElement.dataset.type;
                    if (type && selectedPrintPreviewType !== type) {
                        selectedPrintPreviewType = type;
                        renderPrintContentSelectors();
                        generatePrintPreview();
                    }
                } else if (singlePrintBtn) {
                    const type = singlePrintBtn.dataset.type;
                    handlePrint(type);
                }
            });

            dom.printContentSelectors.addEventListener('change', e => {
                if (e.target.matches('input[type="number"]')) {
                    const type = e.target.dataset.type;
                    const value = parseInt(e.target.value, 10);
                    if (type && !isNaN(value) && value >= 1) {
                        printQuantities[type] = value;
                        if (type === selectedPrintPreviewType) {
                            generatePrintPreview();
                        }
                    }
                }
            });
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoader(true);
            try {
                loadClassroomData();
                loadBuildingsList();
                setupEventListeners();

                if (buildingsList.length > 0) {
                    loadBuildingData(buildingsList[selectedBuildingIndex].id);
                } else {
                    dom.registerRoomCard.innerHTML = `<div class="text-center"><p class="mb-4">ยังไม่มีตึกในระบบ</p><button id="add-first-building-btn" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg">เพิ่มตึกแรก</button></div>`;
                    document.getElementById('add-first-building-btn').onclick = () => openBuildingModal('add');
                }
                
                // Initial renders for summaries that depend on all buildings
                renderSummaryCard();
                renderBuildingSummaryCard();
                renderStudentRoomSummary();

            } catch (error) {
                console.error("Initialization failed:", error);
                showToast("เกิดข้อผิดพลาดในการโหลดข้อมูล โปรดลองรีเฟรชหน้า");
                dom.registerRoomCard.innerHTML = `<p class="text-red-500">ไม่สามารถโหลดข้อมูลได้</p>`;
            } finally {
                showLoader(false);
            }
        });
    </script>
</body>
</html>


